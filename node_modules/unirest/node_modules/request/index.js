// Copyright 2010-2012 Mikeal Rogers
//
//    Licensed under the Apache License, Version 2.0 (the "License"***REMOVED***;
//    you may not use this file except in compliance with the License.
//    You may obtain a copy of the License at
//
//        http://www.apache.org/licenses/LICENSE-2.0
//
//    Unless required by applicable law or agreed to in writing, software
//    distributed under the License is distributed on an "AS IS" BASIS,
//    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//    See the License for the specific language governing permissions and
//    limitations under the License.

var cookies = require('./lib/cookies'***REMOVED***
  , copy = require('./lib/copy'***REMOVED***
  , Request = require('./request'***REMOVED***
  ;



// organize params for patch, post, put, head, del
function initParams(uri, options, callback***REMOVED*** {
  if ((typeof options === 'function'***REMOVED*** && !callback***REMOVED*** callback = options
  if (options && typeof options === 'object'***REMOVED*** {
    options.uri = uri
***REMOVED*** else if (typeof uri === 'string'***REMOVED*** {
    options = {uri:uri}
***REMOVED*** else {
    options = uri
    uri = options.uri
***REMOVED***
  return { uri: uri, options: options, callback: callback }
}

function request (uri, options, callback***REMOVED*** {
  if (typeof uri === 'undefined'***REMOVED*** throw new Error('undefined is not a valid uri or options object.'***REMOVED***
  if ((typeof options === 'function'***REMOVED*** && !callback***REMOVED*** callback = options
  if (options && typeof options === 'object'***REMOVED*** {
    options.uri = uri
***REMOVED*** else if (typeof uri === 'string'***REMOVED*** {
    options = {uri:uri}
***REMOVED*** else {
    options = uri
***REMOVED***

  options = copy(options***REMOVED***

  if (callback***REMOVED*** options.callback = callback
  var r = new Request(options***REMOVED***
  return r
}

module.exports = request

request.Request = Request;

request.debug = process.env.NODE_DEBUG && /request/.test(process.env.NODE_DEBUG***REMOVED***

request.initParams = initParams

request.defaults = function (options, requester***REMOVED*** {
  var def = function (method***REMOVED*** {
    var d = function (uri, opts, callback***REMOVED*** {
      var params = initParams(uri, opts, callback***REMOVED***
      for (var i in options***REMOVED*** {
        if (params.options[i] === undefined***REMOVED*** params.options[i] = options[i]
    ***REMOVED***
      if(typeof requester === 'function'***REMOVED*** {
        if(method === request***REMOVED*** {
          method = requester
      ***REMOVED*** else {
          params.options._requester = requester
      ***REMOVED***
    ***REMOVED***
      return method(params.options, params.callback***REMOVED***
  ***REMOVED***
    return d
***REMOVED***
  var de = def(request***REMOVED***
  de.get = def(request.get***REMOVED***
  de.patch = def(request.patch***REMOVED***
  de.post = def(request.post***REMOVED***
  de.put = def(request.put***REMOVED***
  de.head = def(request.head***REMOVED***
  de.del = def(request.del***REMOVED***
  de.cookie = def(request.cookie***REMOVED***
  de.jar = request.jar
  return de
}

function requester(params***REMOVED*** {
  if(typeof params.options._requester === 'function'***REMOVED*** {
    return params.options._requester
***REMOVED*** else {
    return request
***REMOVED***
}

request.forever = function (agentOptions, optionsArg***REMOVED*** {
  var options = {}
  if (optionsArg***REMOVED*** {
    for (var option in optionsArg***REMOVED*** {
      options[option] = optionsArg[option]
  ***REMOVED***
***REMOVED***
  if (agentOptions***REMOVED*** options.agentOptions = agentOptions
  options.forever = true
  return request.defaults(options***REMOVED***
}

request.get = request
request.post = function (uri, options, callback***REMOVED*** {
  var params = initParams(uri, options, callback***REMOVED***
  params.options.method = 'POST'
  return requester(params***REMOVED***(params.uri || null, params.options, params.callback***REMOVED***
}
request.put = function (uri, options, callback***REMOVED*** {
  var params = initParams(uri, options, callback***REMOVED***
  params.options.method = 'PUT'
  return requester(params***REMOVED***(params.uri || null, params.options, params.callback***REMOVED***
}
request.patch = function (uri, options, callback***REMOVED*** {
  var params = initParams(uri, options, callback***REMOVED***
  params.options.method = 'PATCH'
  return requester(params***REMOVED***(params.uri || null, params.options, params.callback***REMOVED***
}
request.head = function (uri, options, callback***REMOVED*** {
  var params = initParams(uri, options, callback***REMOVED***
  params.options.method = 'HEAD'
  if (params.options.body ||
      params.options.requestBodyStream ||
      (params.options.json && typeof params.options.json !== 'boolean'***REMOVED*** ||
      params.options.multipart***REMOVED*** {
    throw new Error("HTTP HEAD requests MUST NOT include a request body."***REMOVED***
***REMOVED***

  return requester(params***REMOVED***(params.uri || null, params.options, params.callback***REMOVED***
}
request.del = function (uri, options, callback***REMOVED*** {
  var params = initParams(uri, options, callback***REMOVED***
  params.options.method = 'DELETE'
  return requester(params***REMOVED***(params.uri || null, params.options, params.callback***REMOVED***
}
request.jar = function (***REMOVED*** {
  return cookies.jar(***REMOVED***;
}
request.cookie = function (str***REMOVED*** {
  return cookies.parse(str***REMOVED***;
}
