// Load modules

var Lab = require('lab'***REMOVED***;
var Hoek = require('hoek'***REMOVED***;
var Hawk = require('../lib'***REMOVED***;
var Browser = require('../lib/browser'***REMOVED***;
var LocalStorage = require('localStorage'***REMOVED***;


// Declare internals

var internals = {};


// Test shortcuts

var expect = Lab.expect;
var before = Lab.before;
var after = Lab.after;
var describe = Lab.experiment;
var it = Lab.test;


describe('Browser', function (***REMOVED*** {

    var credentialsFunc = function (id, callback***REMOVED*** {

        var credentials = {
            id: id,
            key: 'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn',
            algorithm: (id === '1' ? 'sha1' : 'sha256'***REMOVED***,
            user: 'steve'
      ***REMOVED***;

        return callback(null, credentials***REMOVED***;
  ***REMOVED***;

    it('should generate a header then successfully parse it (configuration***REMOVED***', function (done***REMOVED*** {

        var req = {
            method: 'GET',
            url: '/resource/4?filter=a',
            host: 'example.com',
            port: 8080
      ***REMOVED***;

        credentialsFunc('123456', function (err, credentials***REMOVED*** {

            req.authorization = Browser.client.header('http://example.com:8080/resource/4?filter=a', req.method, { credentials: credentials, ext: 'some-app-data' }***REMOVED***.field;
            expect(req.authorization***REMOVED***.to.exist;

            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts***REMOVED*** {

                expect(err***REMOVED***.to.not.exist;
                expect(credentials.user***REMOVED***.to.equal('steve'***REMOVED***;
                expect(artifacts.ext***REMOVED***.to.equal('some-app-data'***REMOVED***;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;
      ***REMOVED******REMOVED***;
  ***REMOVED******REMOVED***;

    it('should generate a header then successfully parse it (node request***REMOVED***', function (done***REMOVED*** {

        var req = {
            method: 'POST',
            url: '/resource/4?filter=a',
            headers: {
                host: 'example.com:8080',
                'content-type': 'text/plain;x=y'
          ***REMOVED***
      ***REMOVED***;

        var payload = 'some not so random text';

        credentialsFunc('123456', function (err, credentials***REMOVED*** {

            var reqHeader = Browser.client.header('http://example.com:8080/resource/4?filter=a', req.method, { credentials: credentials, ext: 'some-app-data', payload: payload, contentType: req.headers['content-type'] }***REMOVED***;
            req.headers.authorization = reqHeader.field;

            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts***REMOVED*** {

                expect(err***REMOVED***.to.not.exist;
                expect(credentials.user***REMOVED***.to.equal('steve'***REMOVED***;
                expect(artifacts.ext***REMOVED***.to.equal('some-app-data'***REMOVED***;
                expect(Hawk.server.authenticatePayload(payload, credentials, artifacts, req.headers['content-type']***REMOVED******REMOVED***.to.equal(true***REMOVED***;

                var res = {
                    headers: {
                        'content-type': 'text/plain'
                  ***REMOVED***,
                    getResponseHeader: function (header***REMOVED*** {

                        return res.headers[header.toLowerCase(***REMOVED***];
                  ***REMOVED***
              ***REMOVED***;

                res.headers['server-authorization'] = Hawk.server.header(credentials, artifacts, { payload: 'some reply', contentType: 'text/plain', ext: 'response-specific' }***REMOVED***;
                expect(res.headers['server-authorization']***REMOVED***.to.exist;

                expect(Browser.client.authenticate(res, credentials, artifacts, { payload: 'some reply' }***REMOVED******REMOVED***.to.equal(true***REMOVED***;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;
      ***REMOVED******REMOVED***;
  ***REMOVED******REMOVED***;

    it('should generate a header then successfully parse it (no server header options***REMOVED***', function (done***REMOVED*** {

        var req = {
            method: 'POST',
            url: '/resource/4?filter=a',
            headers: {
                host: 'example.com:8080',
                'content-type': 'text/plain;x=y'
          ***REMOVED***
      ***REMOVED***;

        var payload = 'some not so random text';

        credentialsFunc('123456', function (err, credentials***REMOVED*** {

            var reqHeader = Browser.client.header('http://example.com:8080/resource/4?filter=a', req.method, { credentials: credentials, ext: 'some-app-data', payload: payload, contentType: req.headers['content-type'] }***REMOVED***;
            req.headers.authorization = reqHeader.field;

            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts***REMOVED*** {

                expect(err***REMOVED***.to.not.exist;
                expect(credentials.user***REMOVED***.to.equal('steve'***REMOVED***;
                expect(artifacts.ext***REMOVED***.to.equal('some-app-data'***REMOVED***;
                expect(Hawk.server.authenticatePayload(payload, credentials, artifacts, req.headers['content-type']***REMOVED******REMOVED***.to.equal(true***REMOVED***;

                var res = {
                    headers: {
                        'content-type': 'text/plain'
                  ***REMOVED***,
                    getResponseHeader: function (header***REMOVED*** {

                        return res.headers[header.toLowerCase(***REMOVED***];
                  ***REMOVED***
              ***REMOVED***;

                res.headers['server-authorization'] = Hawk.server.header(credentials, artifacts***REMOVED***;
                expect(res.headers['server-authorization']***REMOVED***.to.exist;

                expect(Browser.client.authenticate(res, credentials, artifacts***REMOVED******REMOVED***.to.equal(true***REMOVED***;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;
      ***REMOVED******REMOVED***;
  ***REMOVED******REMOVED***;

    it('should generate a header then successfully parse it (no server header***REMOVED***', function (done***REMOVED*** {

        var req = {
            method: 'POST',
            url: '/resource/4?filter=a',
            headers: {
                host: 'example.com:8080',
                'content-type': 'text/plain;x=y'
          ***REMOVED***
      ***REMOVED***;

        var payload = 'some not so random text';

        credentialsFunc('123456', function (err, credentials***REMOVED*** {

            var reqHeader = Browser.client.header('http://example.com:8080/resource/4?filter=a', req.method, { credentials: credentials, ext: 'some-app-data', payload: payload, contentType: req.headers['content-type'] }***REMOVED***;
            req.headers.authorization = reqHeader.field;

            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts***REMOVED*** {

                expect(err***REMOVED***.to.not.exist;
                expect(credentials.user***REMOVED***.to.equal('steve'***REMOVED***;
                expect(artifacts.ext***REMOVED***.to.equal('some-app-data'***REMOVED***;
                expect(Hawk.server.authenticatePayload(payload, credentials, artifacts, req.headers['content-type']***REMOVED******REMOVED***.to.equal(true***REMOVED***;

                var res = {
                    headers: {
                        'content-type': 'text/plain'
                  ***REMOVED***,
                    getResponseHeader: function (header***REMOVED*** {

                        return res.headers[header.toLowerCase(***REMOVED***];
                  ***REMOVED***
              ***REMOVED***;

                expect(Browser.client.authenticate(res, credentials, artifacts***REMOVED******REMOVED***.to.equal(true***REMOVED***;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;
      ***REMOVED******REMOVED***;
  ***REMOVED******REMOVED***;

    it('should generate a header with stale ts and successfully authenticate on second call', function (done***REMOVED*** {

        var req = {
            method: 'GET',
            url: '/resource/4?filter=a',
            host: 'example.com',
            port: 8080
      ***REMOVED***;

        credentialsFunc('123456', function (err, credentials***REMOVED*** {

            Browser.utils.setNtpOffset(60 * 60 * 1000***REMOVED***;
            var header = Browser.client.header('http://example.com:8080/resource/4?filter=a', req.method, { credentials: credentials, ext: 'some-app-data' }***REMOVED***;
            req.authorization = header.field;
            expect(req.authorization***REMOVED***.to.exist;

            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts***REMOVED*** {

                expect(err***REMOVED***.to.exist;
                expect(err.message***REMOVED***.to.equal('Stale timestamp'***REMOVED***;

                var res = {
                    headers: {
                        'www-authenticate': err.response.headers['WWW-Authenticate']
                  ***REMOVED***,
                    getResponseHeader: function (header***REMOVED*** {

                        return res.headers[header.toLowerCase(***REMOVED***];
                  ***REMOVED***
              ***REMOVED***;

                expect(Browser.utils.getNtpOffset(***REMOVED******REMOVED***.to.equal(60 * 60 * 1000***REMOVED***;
                expect(Browser.client.authenticate(res, credentials, header.artifacts***REMOVED******REMOVED***.to.equal(true***REMOVED***;
                expect(Browser.utils.getNtpOffset(***REMOVED******REMOVED***.to.equal(0***REMOVED***;

                req.authorization = Browser.client.header('http://example.com:8080/resource/4?filter=a', req.method, { credentials: credentials, ext: 'some-app-data' }***REMOVED***.field;
                expect(req.authorization***REMOVED***.to.exist;

                Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts***REMOVED*** {

                    expect(err***REMOVED***.to.not.exist;
                    expect(credentials.user***REMOVED***.to.equal('steve'***REMOVED***;
                    expect(artifacts.ext***REMOVED***.to.equal('some-app-data'***REMOVED***;
                    done(***REMOVED***;
              ***REMOVED******REMOVED***;
          ***REMOVED******REMOVED***;
      ***REMOVED******REMOVED***;
  ***REMOVED******REMOVED***;

    it('should generate a header with stale ts and successfully authenticate on second call (manual localStorage***REMOVED***', function (done***REMOVED*** {

        var req = {
            method: 'GET',
            url: '/resource/4?filter=a',
            host: 'example.com',
            port: 8080
      ***REMOVED***;

        credentialsFunc('123456', function (err, credentials***REMOVED*** {
            Browser.utils.setStorage(LocalStorage***REMOVED***

            Browser.utils.setNtpOffset(60 * 60 * 1000***REMOVED***;
            var header = Browser.client.header('http://example.com:8080/resource/4?filter=a', req.method, { credentials: credentials, ext: 'some-app-data' }***REMOVED***;
            req.authorization = header.field;
            expect(req.authorization***REMOVED***.to.exist;

            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts***REMOVED*** {

                expect(err***REMOVED***.to.exist;
                expect(err.message***REMOVED***.to.equal('Stale timestamp'***REMOVED***;

                var res = {
                    headers: {
                        'www-authenticate': err.response.headers['WWW-Authenticate']
                  ***REMOVED***,
                    getResponseHeader: function (header***REMOVED*** {

                        return res.headers[header.toLowerCase(***REMOVED***];
                  ***REMOVED***
              ***REMOVED***;

                expect(parseInt(LocalStorage.getItem('hawk_ntp_offset'***REMOVED******REMOVED******REMOVED***.to.equal(60 * 60 * 1000***REMOVED***;
                expect(Browser.utils.getNtpOffset(***REMOVED******REMOVED***.to.equal(60 * 60 * 1000***REMOVED***;
                expect(Browser.client.authenticate(res, credentials, header.artifacts***REMOVED******REMOVED***.to.equal(true***REMOVED***;
                expect(Browser.utils.getNtpOffset(***REMOVED******REMOVED***.to.equal(0***REMOVED***;
                expect(parseInt(LocalStorage.getItem('hawk_ntp_offset'***REMOVED******REMOVED******REMOVED***.to.equal(0***REMOVED***;

                req.authorization = Browser.client.header('http://example.com:8080/resource/4?filter=a', req.method, { credentials: credentials, ext: 'some-app-data' }***REMOVED***.field;
                expect(req.authorization***REMOVED***.to.exist;

                Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts***REMOVED*** {

                    expect(err***REMOVED***.to.not.exist;
                    expect(credentials.user***REMOVED***.to.equal('steve'***REMOVED***;
                    expect(artifacts.ext***REMOVED***.to.equal('some-app-data'***REMOVED***;
                    done(***REMOVED***;
              ***REMOVED******REMOVED***;
          ***REMOVED******REMOVED***;
      ***REMOVED******REMOVED***;
  ***REMOVED******REMOVED***;

    it('should generate a header then fails to parse it (missing server header hash***REMOVED***', function (done***REMOVED*** {

        var req = {
            method: 'POST',
            url: '/resource/4?filter=a',
            headers: {
                host: 'example.com:8080',
                'content-type': 'text/plain;x=y'
          ***REMOVED***
      ***REMOVED***;

        var payload = 'some not so random text';

        credentialsFunc('123456', function (err, credentials***REMOVED*** {

            var reqHeader = Browser.client.header('http://example.com:8080/resource/4?filter=a', req.method, { credentials: credentials, ext: 'some-app-data', payload: payload, contentType: req.headers['content-type'] }***REMOVED***;
            req.headers.authorization = reqHeader.field;

            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts***REMOVED*** {

                expect(err***REMOVED***.to.not.exist;
                expect(credentials.user***REMOVED***.to.equal('steve'***REMOVED***;
                expect(artifacts.ext***REMOVED***.to.equal('some-app-data'***REMOVED***;
                expect(Hawk.server.authenticatePayload(payload, credentials, artifacts, req.headers['content-type']***REMOVED******REMOVED***.to.equal(true***REMOVED***;

                var res = {
                    headers: {
                        'content-type': 'text/plain'
                  ***REMOVED***,
                    getResponseHeader: function (header***REMOVED*** {

                        return res.headers[header.toLowerCase(***REMOVED***];
                  ***REMOVED***
              ***REMOVED***;

                res.headers['server-authorization'] = Hawk.server.header(credentials, artifacts***REMOVED***;
                expect(res.headers['server-authorization']***REMOVED***.to.exist;

                expect(Browser.client.authenticate(res, credentials, artifacts, { payload: 'some reply' }***REMOVED******REMOVED***.to.equal(false***REMOVED***;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;
      ***REMOVED******REMOVED***;
  ***REMOVED******REMOVED***;

    it('should generate a header then successfully parse it (with hash***REMOVED***', function (done***REMOVED*** {

        var req = {
            method: 'GET',
            url: '/resource/4?filter=a',
            host: 'example.com',
            port: 8080
      ***REMOVED***;

        credentialsFunc('123456', function (err, credentials***REMOVED*** {

            req.authorization = Browser.client.header('http://example.com:8080/resource/4?filter=a', req.method, { credentials: credentials, payload: 'hola!', ext: 'some-app-data' }***REMOVED***.field;
            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts***REMOVED*** {

                expect(err***REMOVED***.to.not.exist;
                expect(credentials.user***REMOVED***.to.equal('steve'***REMOVED***;
                expect(artifacts.ext***REMOVED***.to.equal('some-app-data'***REMOVED***;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;
      ***REMOVED******REMOVED***;
  ***REMOVED******REMOVED***;

    it('should generate a header then successfully parse it then validate payload', function (done***REMOVED*** {

        var req = {
            method: 'GET',
            url: '/resource/4?filter=a',
            host: 'example.com',
            port: 8080
      ***REMOVED***;

        credentialsFunc('123456', function (err, credentials***REMOVED*** {

            req.authorization = Browser.client.header('http://example.com:8080/resource/4?filter=a', req.method, { credentials: credentials, payload: 'hola!', ext: 'some-app-data' }***REMOVED***.field;
            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts***REMOVED*** {

                expect(err***REMOVED***.to.not.exist;
                expect(credentials.user***REMOVED***.to.equal('steve'***REMOVED***;
                expect(artifacts.ext***REMOVED***.to.equal('some-app-data'***REMOVED***;
                expect(Hawk.server.authenticatePayload('hola!', credentials, artifacts***REMOVED******REMOVED***.to.be.true;
                expect(Hawk.server.authenticatePayload('hello!', credentials, artifacts***REMOVED******REMOVED***.to.be.false;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;
      ***REMOVED******REMOVED***;
  ***REMOVED******REMOVED***;

    it('should generate a header then successfully parse it (app***REMOVED***', function (done***REMOVED*** {

        var req = {
            method: 'GET',
            url: '/resource/4?filter=a',
            host: 'example.com',
            port: 8080
      ***REMOVED***;

        credentialsFunc('123456', function (err, credentials***REMOVED*** {

            req.authorization = Browser.client.header('http://example.com:8080/resource/4?filter=a', req.method, { credentials: credentials, ext: 'some-app-data', app: 'asd23ased' }***REMOVED***.field;
            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts***REMOVED*** {

                expect(err***REMOVED***.to.not.exist;
                expect(credentials.user***REMOVED***.to.equal('steve'***REMOVED***;
                expect(artifacts.ext***REMOVED***.to.equal('some-app-data'***REMOVED***;
                expect(artifacts.app***REMOVED***.to.equal('asd23ased'***REMOVED***;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;
      ***REMOVED******REMOVED***;
  ***REMOVED******REMOVED***;

    it('should generate a header then successfully parse it (app, dlg***REMOVED***', function (done***REMOVED*** {

        var req = {
            method: 'GET',
            url: '/resource/4?filter=a',
            host: 'example.com',
            port: 8080
      ***REMOVED***;

        credentialsFunc('123456', function (err, credentials***REMOVED*** {

            req.authorization = Browser.client.header('http://example.com:8080/resource/4?filter=a', req.method, { credentials: credentials, ext: 'some-app-data', app: 'asd23ased', dlg: '23434szr3q4d' }***REMOVED***.field;
            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts***REMOVED*** {

                expect(err***REMOVED***.to.not.exist;
                expect(credentials.user***REMOVED***.to.equal('steve'***REMOVED***;
                expect(artifacts.ext***REMOVED***.to.equal('some-app-data'***REMOVED***;
                expect(artifacts.app***REMOVED***.to.equal('asd23ased'***REMOVED***;
                expect(artifacts.dlg***REMOVED***.to.equal('23434szr3q4d'***REMOVED***;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;
      ***REMOVED******REMOVED***;
  ***REMOVED******REMOVED***;

    it('should generate a header then fail authentication due to bad hash', function (done***REMOVED*** {

        var req = {
            method: 'GET',
            url: '/resource/4?filter=a',
            host: 'example.com',
            port: 8080
      ***REMOVED***;

        credentialsFunc('123456', function (err, credentials***REMOVED*** {

            req.authorization = Browser.client.header('http://example.com:8080/resource/4?filter=a', req.method, { credentials: credentials, payload: 'hola!', ext: 'some-app-data' }***REMOVED***.field;
            Hawk.server.authenticate(req, credentialsFunc, { payload: 'byebye!' }, function (err, credentials, artifacts***REMOVED*** {

                expect(err***REMOVED***.to.exist;
                expect(err.response.payload.message***REMOVED***.to.equal('Bad payload hash'***REMOVED***;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;
      ***REMOVED******REMOVED***;
  ***REMOVED******REMOVED***;

    it('should generate a header for one resource then fail to authenticate another', function (done***REMOVED*** {

        var req = {
            method: 'GET',
            url: '/resource/4?filter=a',
            host: 'example.com',
            port: 8080
      ***REMOVED***;

        credentialsFunc('123456', function (err, credentials***REMOVED*** {

            req.authorization = Browser.client.header('http://example.com:8080/resource/4?filter=a', req.method, { credentials: credentials, ext: 'some-app-data' }***REMOVED***.field;
            req.url = '/something/else';

            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts***REMOVED*** {

                expect(err***REMOVED***.to.exist;
                expect(credentials***REMOVED***.to.exist;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;
      ***REMOVED******REMOVED***;
  ***REMOVED******REMOVED***;

    describe('client', function (***REMOVED*** {

        describe('#header', function (***REMOVED*** {

            it('should return a valid authorization header (sha1***REMOVED***', function (done***REMOVED*** {

                var credentials = {
                    id: '123456',
                    key: '2983d45yun89q',
                    algorithm: 'sha1'
              ***REMOVED***;

                var header = Browser.client.header('http://example.net/somewhere/over/the/rainbow', 'POST', { credentials: credentials, ext: 'Bazinga!', timestamp: 1353809207, nonce: 'Ygvqdz', payload: 'something to write about' }***REMOVED***.field;
                expect(header***REMOVED***.to.equal('Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="bsvY3IfUllw6V5rvk4tStEvpBhE=", ext="Bazinga!", mac="qbf1ZPG/r/e06F4ht+T77LXi5vw="'***REMOVED***;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;

            it('should return a valid authorization header (sha256***REMOVED***', function (done***REMOVED*** {

                var credentials = {
                    id: '123456',
                    key: '2983d45yun89q',
                    algorithm: 'sha256'
              ***REMOVED***;

                var header = Browser.client.header('https://example.net/somewhere/over/the/rainbow', 'POST', { credentials: credentials, ext: 'Bazinga!', timestamp: 1353809207, nonce: 'Ygvqdz', payload: 'something to write about', contentType: 'text/plain' }***REMOVED***.field;
                expect(header***REMOVED***.to.equal('Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=", ext="Bazinga!", mac="q1CwFoSHzPZSkbIvl0oYlD+91rBUEvFk763nMjMndj8="'***REMOVED***;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;

            it('should return a valid authorization header (no ext***REMOVED***', function (done***REMOVED*** {

                var credentials = {
                    id: '123456',
                    key: '2983d45yun89q',
                    algorithm: 'sha256'
              ***REMOVED***;

                var header = Browser.client.header('https://example.net/somewhere/over/the/rainbow', 'POST', { credentials: credentials, timestamp: 1353809207, nonce: 'Ygvqdz', payload: 'something to write about', contentType: 'text/plain' }***REMOVED***.field;
                expect(header***REMOVED***.to.equal('Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=", mac="HTgtd0jPI6E4izx8e4OHdO36q00xFCU0FolNq3RiCYs="'***REMOVED***;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;

            it('should return an empty authorization header on missing options', function (done***REMOVED*** {

                var header = Browser.client.header('https://example.net/somewhere/over/the/rainbow', 'POST'***REMOVED***.field;
                expect(header***REMOVED***.to.equal(''***REMOVED***;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;

            it('should return an empty authorization header on invalid credentials', function (done***REMOVED*** {

                var credentials = {
                    key: '2983d45yun89q',
                    algorithm: 'sha256'
              ***REMOVED***;

                var header = Browser.client.header('https://example.net/somewhere/over/the/rainbow', 'POST', { credentials: credentials, ext: 'Bazinga!', timestamp: 1353809207 }***REMOVED***.field;
                expect(header***REMOVED***.to.equal(''***REMOVED***;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;

            it('should return an empty authorization header on invalid algorithm', function (done***REMOVED*** {

                var credentials = {
                    id: '123456',
                    key: '2983d45yun89q',
                    algorithm: 'hmac-sha-0'
              ***REMOVED***;

                var header = Browser.client.header('https://example.net/somewhere/over/the/rainbow', 'POST', { credentials: credentials, payload: 'something, anything!', ext: 'Bazinga!', timestamp: 1353809207 }***REMOVED***.field;
                expect(header***REMOVED***.to.equal(''***REMOVED***;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;
      ***REMOVED******REMOVED***;

        describe('#authenticate', function (***REMOVED*** {

            it('should return false on invalid header', function (done***REMOVED*** {

                var res = {
                    headers: {
                        'server-authorization': 'Hawk mac="abc", bad="xyz"'
                  ***REMOVED***,
                    getResponseHeader: function (header***REMOVED*** {

                        return res.headers[header.toLowerCase(***REMOVED***];
                  ***REMOVED***
              ***REMOVED***;

                expect(Browser.client.authenticate(res, {}***REMOVED******REMOVED***.to.equal(false***REMOVED***;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;

            it('should return false on invalid mac', function (done***REMOVED*** {

                var res = {
                    headers: {
                        'content-type': 'text/plain',
                        'server-authorization': 'Hawk mac="_IJRsMl/4oL+nn+vKoeVZPdCHXB4yJkNnBbTbHFZUYE=", hash="f9cDF/TDm7TkYRLnGwRMfeDzT6LixQVLvrIKhh0vgmM=", ext="response-specific"'
                  ***REMOVED***,
                    getResponseHeader: function (header***REMOVED*** {

                        return res.headers[header.toLowerCase(***REMOVED***];
                  ***REMOVED***
              ***REMOVED***;

                var artifacts = {
                    method: 'POST',
                    host: 'example.com',
                    port: '8080',
                    resource: '/resource/4?filter=a',
                    ts: '1362336900',
                    nonce: 'eb5S_L',
                    hash: 'nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=',
                    ext: 'some-app-data',
                    app: undefined,
                    dlg: undefined,
                    mac: 'BlmSe8K+pbKIb6YsZCnt4E1GrYvY1AaYayNR82dGpIk=',
                    id: '123456'
              ***REMOVED***;

                var credentials = {
                    id: '123456',
                    key: 'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn',
                    algorithm: 'sha256',
                    user: 'steve'
              ***REMOVED***;

                expect(Browser.client.authenticate(res, credentials, artifacts***REMOVED******REMOVED***.to.equal(false***REMOVED***;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;

            it('should return true on ignoring hash', function (done***REMOVED*** {

                var res = {
                    headers: {
                        'content-type': 'text/plain',
                        'server-authorization': 'Hawk mac="XIJRsMl/4oL+nn+vKoeVZPdCHXB4yJkNnBbTbHFZUYE=", hash="f9cDF/TDm7TkYRLnGwRMfeDzT6LixQVLvrIKhh0vgmM=", ext="response-specific"'
                  ***REMOVED***,
                    getResponseHeader: function (header***REMOVED*** {

                        return res.headers[header.toLowerCase(***REMOVED***];
                  ***REMOVED***
              ***REMOVED***;

                var artifacts = {
                    method: 'POST',
                    host: 'example.com',
                    port: '8080',
                    resource: '/resource/4?filter=a',
                    ts: '1362336900',
                    nonce: 'eb5S_L',
                    hash: 'nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=',
                    ext: 'some-app-data',
                    app: undefined,
                    dlg: undefined,
                    mac: 'BlmSe8K+pbKIb6YsZCnt4E1GrYvY1AaYayNR82dGpIk=',
                    id: '123456'
              ***REMOVED***;

                var credentials = {
                    id: '123456',
                    key: 'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn',
                    algorithm: 'sha256',
                    user: 'steve'
              ***REMOVED***;

                expect(Browser.client.authenticate(res, credentials, artifacts***REMOVED******REMOVED***.to.equal(true***REMOVED***;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;

            it('should fail on invalid WWW-Authenticate header format', function (done***REMOVED*** {

                var res = {
                    headers: {
                        'www-authenticate': 'Hawk ts="1362346425875", tsm="PhwayS28vtnn3qbv0mqRBYSXebN/zggEtucfeZ620Zo=", x="Stale timestamp"'
                  ***REMOVED***,
                    getResponseHeader: function (header***REMOVED*** {

                        return res.headers[header.toLowerCase(***REMOVED***];
                  ***REMOVED***
              ***REMOVED***;

                expect(Browser.client.authenticate(res, {}***REMOVED******REMOVED***.to.equal(false***REMOVED***;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;

            it('should fail on invalid WWW-Authenticate header format', function (done***REMOVED*** {

                var credentials = {
                    id: '123456',
                    key: 'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn',
                    algorithm: 'sha256',
                    user: 'steve'
              ***REMOVED***;

                var res = {
                    headers: {
                        'www-authenticate': 'Hawk ts="1362346425875", tsm="hwayS28vtnn3qbv0mqRBYSXebN/zggEtucfeZ620Zo=", error="Stale timestamp"'
                  ***REMOVED***,
                    getResponseHeader: function (header***REMOVED*** {

                        return res.headers[header.toLowerCase(***REMOVED***];
                  ***REMOVED***
              ***REMOVED***;

                expect(Browser.client.authenticate(res, credentials***REMOVED******REMOVED***.to.equal(false***REMOVED***;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;
      ***REMOVED******REMOVED***;

        describe('#message', function (***REMOVED*** {
            it('should generate an authorization then successfully parse it', function (done***REMOVED*** {

                credentialsFunc('123456', function (err, credentials***REMOVED*** {

                    var auth = Browser.client.message('example.com', 8080, 'some message', { credentials: credentials }***REMOVED***;
                    expect(auth***REMOVED***.to.exist;

                    Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, credentialsFunc, {}, function (err, credentials***REMOVED*** {

                        expect(err***REMOVED***.to.not.exist;
                        expect(credentials.user***REMOVED***.to.equal('steve'***REMOVED***;
                        done(***REMOVED***;
                  ***REMOVED******REMOVED***;
              ***REMOVED******REMOVED***;
          ***REMOVED******REMOVED***;

            it('should fail on missing host', function (done***REMOVED*** {

                credentialsFunc('123456', function (err, credentials***REMOVED*** {

                    var auth = Browser.client.message(null, 8080, 'some message', { credentials: credentials }***REMOVED***;
                    expect(auth***REMOVED***.to.not.exist;
                    done(***REMOVED***;
              ***REMOVED******REMOVED***;
          ***REMOVED******REMOVED***;

            it('should fail on missing credentials', function (done***REMOVED*** {

                var auth = Browser.client.message('example.com', 8080, 'some message', {}***REMOVED***;
                expect(auth***REMOVED***.to.not.exist;
                done(***REMOVED***;
          ***REMOVED******REMOVED***;

            it('should fail on invalid algorithm', function (done***REMOVED*** {

                credentialsFunc('123456', function (err, credentials***REMOVED*** {

                    var creds = Hoek.clone(credentials***REMOVED***;
                    creds.algorithm = 'blah';
                    var auth = Browser.client.message('example.com', 8080, 'some message', { credentials: creds }***REMOVED***;
                    expect(auth***REMOVED***.to.not.exist;
                    done(***REMOVED***;
              ***REMOVED******REMOVED***;
          ***REMOVED******REMOVED***;
      ***REMOVED******REMOVED***;
  ***REMOVED******REMOVED***;

    describe('#parseAuthorizationHeader', function (done***REMOVED*** {

        it('returns null on missing header', function (done***REMOVED*** {

            expect(Browser.utils.parseAuthorizationHeader(***REMOVED******REMOVED***.to.equal(null***REMOVED***;
            done(***REMOVED***;
      ***REMOVED******REMOVED***;

        it('returns null on bad header syntax (structure***REMOVED***', function (done***REMOVED*** {

            expect(Browser.utils.parseAuthorizationHeader('Hawk'***REMOVED******REMOVED***.to.equal(null***REMOVED***;
            done(***REMOVED***;
      ***REMOVED******REMOVED***;

        it('returns null on bad header syntax (parts***REMOVED***', function (done***REMOVED*** {

            expect(Browser.utils.parseAuthorizationHeader(' '***REMOVED******REMOVED***.to.equal(null***REMOVED***;
            done(***REMOVED***;
      ***REMOVED******REMOVED***;

        it('returns null on bad scheme name', function (done***REMOVED*** {

            expect(Browser.utils.parseAuthorizationHeader('Basic asdasd'***REMOVED******REMOVED***.to.equal(null***REMOVED***;
            done(***REMOVED***;
      ***REMOVED******REMOVED***;

        it('returns null on bad attribute value', function (done***REMOVED*** {

            expect(Browser.utils.parseAuthorizationHeader('Hawk test="\t"', ['test']***REMOVED******REMOVED***.to.equal(null***REMOVED***;
            done(***REMOVED***;
      ***REMOVED******REMOVED***;

        it('returns null on duplicated attribute', function (done***REMOVED*** {

            expect(Browser.utils.parseAuthorizationHeader('Hawk test="a", test="b"', ['test']***REMOVED******REMOVED***.to.equal(null***REMOVED***;
            done(***REMOVED***;
      ***REMOVED******REMOVED***;
  ***REMOVED******REMOVED***;
}***REMOVED***;
