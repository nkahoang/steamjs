module.exports = stringify;

function getSerialize (fn, decycle***REMOVED*** {
  var seen = [], keys = [];
  decycle = decycle || function(key, value***REMOVED*** {
    return '[Circular ' + getPath(value, seen, keys***REMOVED*** + ']'
***REMOVED***;
  return function(key, value***REMOVED*** {
    var ret = value;
    if (typeof value === 'object' && value***REMOVED*** {
      if (seen.indexOf(value***REMOVED*** !== -1***REMOVED***
        ret = decycle(key, value***REMOVED***;
      else {
        seen.push(value***REMOVED***;
        keys.push(key***REMOVED***;
    ***REMOVED***
  ***REMOVED***
    if (fn***REMOVED*** ret = fn(key, ret***REMOVED***;
    return ret;
***REMOVED***
}

function getPath (value, seen, keys***REMOVED*** {
  var index = seen.indexOf(value***REMOVED***;
  var path = [ keys[index] ];
  for (index--; index >= 0; index--***REMOVED*** {
    if (seen[index][ path[0] ] === value***REMOVED*** {
      value = seen[index];
      path.unshift(keys[index]***REMOVED***;
  ***REMOVED***
***REMOVED***
  return '~' + path.join('.'***REMOVED***;
}

function stringify(obj, fn, spaces, decycle***REMOVED*** {
  return JSON.stringify(obj, getSerialize(fn, decycle***REMOVED***, spaces***REMOVED***;
}

stringify.getSerialize = getSerialize;
