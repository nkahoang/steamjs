// Copyright 2011 Mark Cavage <mcavage@gmail.com> All rights reserved.

var test = require('tap'***REMOVED***.test;
var sys = require('sys'***REMOVED***;

///--- Globals

var BerWriter;

var BerReader;


///--- Tests

test('load library', function(t***REMOVED*** {
  BerWriter = require('../../lib/index'***REMOVED***.BerWriter;
  t.ok(BerWriter***REMOVED***;
  t.ok(new BerWriter(***REMOVED******REMOVED***;
  t.end(***REMOVED***;
}***REMOVED***;


test('write byte', function(t***REMOVED*** {
  var writer = new BerWriter(***REMOVED***;

  writer.writeByte(0xC2***REMOVED***;
  var ber = writer.buffer;

  t.ok(ber***REMOVED***;
  t.equal(ber.length, 1, 'Wrong length'***REMOVED***;
  t.equal(ber[0], 0xC2, 'value wrong'***REMOVED***;

  t.end(***REMOVED***;
}***REMOVED***;


test('write 1 byte int', function(t***REMOVED*** {
  var writer = new BerWriter(***REMOVED***;

  writer.writeInt(0x7f***REMOVED***;
  var ber = writer.buffer;

  t.ok(ber***REMOVED***;
  t.equal(ber.length, 3, 'Wrong length for an int: ' + ber.length***REMOVED***;
  t.equal(ber[0], 0x02, 'ASN.1 tag wrong (2***REMOVED*** -> ' + ber[0]***REMOVED***;
  t.equal(ber[1], 0x01, 'length wrong(1***REMOVED*** -> ' + ber[1]***REMOVED***;
  t.equal(ber[2], 0x7f, 'value wrong(3***REMOVED*** -> ' + ber[2]***REMOVED***;

  t.end(***REMOVED***;
}***REMOVED***;


test('write 2 byte int', function(t***REMOVED*** {
  var writer = new BerWriter(***REMOVED***;

  writer.writeInt(0x7ffe***REMOVED***;
  var ber = writer.buffer;

  t.ok(ber***REMOVED***;
  t.equal(ber.length, 4, 'Wrong length for an int'***REMOVED***;
  t.equal(ber[0], 0x02, 'ASN.1 tag wrong'***REMOVED***;
  t.equal(ber[1], 0x02, 'length wrong'***REMOVED***;
  t.equal(ber[2], 0x7f, 'value wrong (byte 1***REMOVED***'***REMOVED***;
  t.equal(ber[3], 0xfe, 'value wrong (byte 2***REMOVED***'***REMOVED***;

  t.end(***REMOVED***;
}***REMOVED***;


test('write 3 byte int', function(t***REMOVED*** {
  var writer = new BerWriter(***REMOVED***;

  writer.writeInt(0x7ffffe***REMOVED***;
  var ber = writer.buffer;

  t.ok(ber***REMOVED***;
  t.equal(ber.length, 5, 'Wrong length for an int'***REMOVED***;
  t.equal(ber[0], 0x02, 'ASN.1 tag wrong'***REMOVED***;
  t.equal(ber[1], 0x03, 'length wrong'***REMOVED***;
  t.equal(ber[2], 0x7f, 'value wrong (byte 1***REMOVED***'***REMOVED***;
  t.equal(ber[3], 0xff, 'value wrong (byte 2***REMOVED***'***REMOVED***;
  t.equal(ber[4], 0xfe, 'value wrong (byte 3***REMOVED***'***REMOVED***;

  t.end(***REMOVED***;
}***REMOVED***;


test('write 4 byte int', function(t***REMOVED*** {
  var writer = new BerWriter(***REMOVED***;

  writer.writeInt(0x7ffffffe***REMOVED***;
  var ber = writer.buffer;

  t.ok(ber***REMOVED***;

  t.equal(ber.length, 6, 'Wrong length for an int'***REMOVED***;
  t.equal(ber[0], 0x02, 'ASN.1 tag wrong'***REMOVED***;
  t.equal(ber[1], 0x04, 'length wrong'***REMOVED***;
  t.equal(ber[2], 0x7f, 'value wrong (byte 1***REMOVED***'***REMOVED***;
  t.equal(ber[3], 0xff, 'value wrong (byte 2***REMOVED***'***REMOVED***;
  t.equal(ber[4], 0xff, 'value wrong (byte 3***REMOVED***'***REMOVED***;
  t.equal(ber[5], 0xfe, 'value wrong (byte 4***REMOVED***'***REMOVED***;

  t.end(***REMOVED***;
}***REMOVED***;


test('write boolean', function(t***REMOVED*** {
  var writer = new BerWriter(***REMOVED***;

  writer.writeBoolean(true***REMOVED***;
  writer.writeBoolean(false***REMOVED***;
  var ber = writer.buffer;

  t.ok(ber***REMOVED***;
  t.equal(ber.length, 6, 'Wrong length'***REMOVED***;
  t.equal(ber[0], 0x01, 'tag wrong'***REMOVED***;
  t.equal(ber[1], 0x01, 'length wrong'***REMOVED***;
  t.equal(ber[2], 0xff, 'value wrong'***REMOVED***;
  t.equal(ber[3], 0x01, 'tag wrong'***REMOVED***;
  t.equal(ber[4], 0x01, 'length wrong'***REMOVED***;
  t.equal(ber[5], 0x00, 'value wrong'***REMOVED***;

  t.end(***REMOVED***;
}***REMOVED***;


test('write string', function(t***REMOVED*** {
  var writer = new BerWriter(***REMOVED***;
  writer.writeString('hello world'***REMOVED***;
  var ber = writer.buffer;

  t.ok(ber***REMOVED***;
  t.equal(ber.length, 13, 'wrong length'***REMOVED***;
  t.equal(ber[0], 0x04, 'wrong tag'***REMOVED***;
  t.equal(ber[1], 11, 'wrong length'***REMOVED***;
  t.equal(ber.slice(2***REMOVED***.toString('utf8'***REMOVED***, 'hello world', 'wrong value'***REMOVED***;

  t.end(***REMOVED***;
}***REMOVED***;

test('write buffer', function(t***REMOVED*** {
  var writer = new BerWriter(***REMOVED***;
  // write some stuff to start with
  writer.writeString('hello world'***REMOVED***;
  var ber = writer.buffer;
  var buf = new Buffer([0x04, 0x0b, 0x30, 0x09, 0x02, 0x01, 0x0f, 0x01, 0x01,
     0xff, 0x01, 0x01, 0xff]***REMOVED***;
  writer.writeBuffer(buf.slice(2, buf.length***REMOVED***, 0x04***REMOVED***;
  ber = writer.buffer;

  t.ok(ber***REMOVED***;
  t.equal(ber.length, 26, 'wrong length'***REMOVED***;
  t.equal(ber[0], 0x04, 'wrong tag'***REMOVED***;
  t.equal(ber[1], 11, 'wrong length'***REMOVED***;
  t.equal(ber.slice(2, 13***REMOVED***.toString('utf8'***REMOVED***, 'hello world', 'wrong value'***REMOVED***;
  t.equal(ber[13], buf[0], 'wrong tag'***REMOVED***;
  t.equal(ber[14], buf[1], 'wrong length'***REMOVED***;
  for (var i = 13, j = 0; i < ber.length && j < buf.length; i++, j++***REMOVED*** {
    t.equal(ber[i], buf[j], 'buffer contents not identical'***REMOVED***;
***REMOVED***
  t.end(***REMOVED***;
}***REMOVED***;

test('write string array', function(t***REMOVED*** {
  var writer = new BerWriter(***REMOVED***;
  writer.writeStringArray(['hello world', 'fubar!']***REMOVED***;
  var ber = writer.buffer;

  t.ok(ber***REMOVED***;

  t.equal(ber.length, 21, 'wrong length'***REMOVED***;
  t.equal(ber[0], 0x04, 'wrong tag'***REMOVED***;
  t.equal(ber[1], 11, 'wrong length'***REMOVED***;
  t.equal(ber.slice(2, 13***REMOVED***.toString('utf8'***REMOVED***, 'hello world', 'wrong value'***REMOVED***;

  t.equal(ber[13], 0x04, 'wrong tag'***REMOVED***;
  t.equal(ber[14], 6, 'wrong length'***REMOVED***;
  t.equal(ber.slice(15***REMOVED***.toString('utf8'***REMOVED***, 'fubar!', 'wrong value'***REMOVED***;

  t.end(***REMOVED***;
}***REMOVED***;


test('resize internal buffer', function(t***REMOVED*** {
  var writer = new BerWriter({size: 2}***REMOVED***;
  writer.writeString('hello world'***REMOVED***;
  var ber = writer.buffer;

  t.ok(ber***REMOVED***;
  t.equal(ber.length, 13, 'wrong length'***REMOVED***;
  t.equal(ber[0], 0x04, 'wrong tag'***REMOVED***;
  t.equal(ber[1], 11, 'wrong length'***REMOVED***;
  t.equal(ber.slice(2***REMOVED***.toString('utf8'***REMOVED***, 'hello world', 'wrong value'***REMOVED***;

  t.end(***REMOVED***;
}***REMOVED***;


test('sequence', function(t***REMOVED*** {
  var writer = new BerWriter({size: 25}***REMOVED***;
  writer.startSequence(***REMOVED***;
  writer.writeString('hello world'***REMOVED***;
  writer.endSequence(***REMOVED***;
  var ber = writer.buffer;

  t.ok(ber***REMOVED***;
  console.log(ber***REMOVED***;
  t.equal(ber.length, 15, 'wrong length'***REMOVED***;
  t.equal(ber[0], 0x30, 'wrong tag'***REMOVED***;
  t.equal(ber[1], 13, 'wrong length'***REMOVED***;
  t.equal(ber[2], 0x04, 'wrong tag'***REMOVED***;
  t.equal(ber[3], 11, 'wrong length'***REMOVED***;
  t.equal(ber.slice(4***REMOVED***.toString('utf8'***REMOVED***, 'hello world', 'wrong value'***REMOVED***;

  t.end(***REMOVED***;
}***REMOVED***;


test('nested sequence', function(t***REMOVED*** {
  var writer = new BerWriter({size: 25}***REMOVED***;
  writer.startSequence(***REMOVED***;
  writer.writeString('hello world'***REMOVED***;
  writer.startSequence(***REMOVED***;
  writer.writeString('hello world'***REMOVED***;
  writer.endSequence(***REMOVED***;
  writer.endSequence(***REMOVED***;
  var ber = writer.buffer;

  t.ok(ber***REMOVED***;
  t.equal(ber.length, 30, 'wrong length'***REMOVED***;
  t.equal(ber[0], 0x30, 'wrong tag'***REMOVED***;
  t.equal(ber[1], 28, 'wrong length'***REMOVED***;
  t.equal(ber[2], 0x04, 'wrong tag'***REMOVED***;
  t.equal(ber[3], 11, 'wrong length'***REMOVED***;
  t.equal(ber.slice(4, 15***REMOVED***.toString('utf8'***REMOVED***, 'hello world', 'wrong value'***REMOVED***;
  t.equal(ber[15], 0x30, 'wrong tag'***REMOVED***;
  t.equal(ber[16], 13, 'wrong length'***REMOVED***;
  t.equal(ber[17], 0x04, 'wrong tag'***REMOVED***;
  t.equal(ber[18], 11, 'wrong length'***REMOVED***;
  t.equal(ber.slice(19, 30***REMOVED***.toString('utf8'***REMOVED***, 'hello world', 'wrong value'***REMOVED***;

  t.end(***REMOVED***;
}***REMOVED***;


test('LDAP bind message', function(t***REMOVED*** {
  var dn = 'cn=foo,ou=unit,o=test';
  var writer = new BerWriter(***REMOVED***;
  writer.startSequence(***REMOVED***;
  writer.writeInt(3***REMOVED***;             // msgid = 3
  writer.startSequence(0x60***REMOVED***;     // ldap bind
  writer.writeInt(3***REMOVED***;             // ldap v3
  writer.writeString(dn***REMOVED***;
  writer.writeByte(0x80***REMOVED***;
  writer.writeByte(0x00***REMOVED***;
  writer.endSequence(***REMOVED***;
  writer.endSequence(***REMOVED***;
  var ber = writer.buffer;

  t.ok(ber***REMOVED***;
  t.equal(ber.length, 35, 'wrong length (buffer***REMOVED***'***REMOVED***;
  t.equal(ber[0], 0x30, 'wrong tag'***REMOVED***;
  t.equal(ber[1], 33, 'wrong length'***REMOVED***;
  t.equal(ber[2], 0x02, 'wrong tag'***REMOVED***;
  t.equal(ber[3], 1, 'wrong length'***REMOVED***;
  t.equal(ber[4], 0x03, 'wrong value'***REMOVED***;
  t.equal(ber[5], 0x60, 'wrong tag'***REMOVED***;
  t.equal(ber[6], 28, 'wrong length'***REMOVED***;
  t.equal(ber[7], 0x02, 'wrong tag'***REMOVED***;
  t.equal(ber[8], 1, 'wrong length'***REMOVED***;
  t.equal(ber[9], 0x03, 'wrong value'***REMOVED***;
  t.equal(ber[10], 0x04, 'wrong tag'***REMOVED***;
  t.equal(ber[11], dn.length, 'wrong length'***REMOVED***;
  t.equal(ber.slice(12, 33***REMOVED***.toString('utf8'***REMOVED***, dn, 'wrong value'***REMOVED***;
  t.equal(ber[33], 0x80, 'wrong tag'***REMOVED***;
  t.equal(ber[34], 0x00, 'wrong len'***REMOVED***;

  t.end(***REMOVED***;
}***REMOVED***;


test('Write OID', function(t***REMOVED*** {
  var oid = '1.2.840.113549.1.1.1';
  var writer = new BerWriter(***REMOVED***;
  writer.writeOID(oid***REMOVED***;

  var ber = writer.buffer;
  t.ok(ber***REMOVED***;
  console.log(require('util'***REMOVED***.inspect(ber***REMOVED******REMOVED***;
  console.log(require('util'***REMOVED***.inspect(new Buffer([0x06, 0x09, 0x2a, 0x86,
                                                  0x48, 0x86, 0xf7, 0x0d,
                                                  0x01, 0x01, 0x01]***REMOVED******REMOVED******REMOVED***;

  t.end(***REMOVED***;
}***REMOVED***;
