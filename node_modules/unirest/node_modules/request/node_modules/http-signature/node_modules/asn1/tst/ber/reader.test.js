// Copyright 2011 Mark Cavage <mcavage@gmail.com> All rights reserved.

var test = require('tap'***REMOVED***.test;



///--- Globals

var BerReader;



///--- Tests

test('load library', function(t***REMOVED*** {
  BerReader = require('../../lib/index'***REMOVED***.BerReader;
  t.ok(BerReader***REMOVED***;
  try {
    new BerReader(***REMOVED***;
    t.fail('Should have thrown'***REMOVED***;
***REMOVED*** catch (e***REMOVED*** {
    t.ok(e instanceof TypeError, 'Should have been a type error'***REMOVED***;
***REMOVED***
  t.end(***REMOVED***;
}***REMOVED***;


test('read byte', function(t***REMOVED*** {
  var reader = new BerReader(new Buffer([0xde]***REMOVED******REMOVED***;
  t.ok(reader***REMOVED***;
  t.equal(reader.readByte(***REMOVED***, 0xde, 'wrong value'***REMOVED***;
  t.end(***REMOVED***;
}***REMOVED***;


test('read 1 byte int', function(t***REMOVED*** {
  var reader = new BerReader(new Buffer([0x02, 0x01, 0x03]***REMOVED******REMOVED***;
  t.ok(reader***REMOVED***;
  t.equal(reader.readInt(***REMOVED***, 0x03, 'wrong value'***REMOVED***;
  t.equal(reader.length, 0x01, 'wrong length'***REMOVED***;
  t.end(***REMOVED***;
}***REMOVED***;


test('read 2 byte int', function(t***REMOVED*** {
  var reader = new BerReader(new Buffer([0x02, 0x02, 0x7e, 0xde]***REMOVED******REMOVED***;
  t.ok(reader***REMOVED***;
  t.equal(reader.readInt(***REMOVED***, 0x7ede, 'wrong value'***REMOVED***;
  t.equal(reader.length, 0x02, 'wrong length'***REMOVED***;
  t.end(***REMOVED***;
}***REMOVED***;


test('read 3 byte int', function(t***REMOVED*** {
  var reader = new BerReader(new Buffer([0x02, 0x03, 0x7e, 0xde, 0x03]***REMOVED******REMOVED***;
  t.ok(reader***REMOVED***;
  t.equal(reader.readInt(***REMOVED***, 0x7ede03, 'wrong value'***REMOVED***;
  t.equal(reader.length, 0x03, 'wrong length'***REMOVED***;
  t.end(***REMOVED***;
}***REMOVED***;


test('read 4 byte int', function(t***REMOVED*** {
  var reader = new BerReader(new Buffer([0x02, 0x04, 0x7e, 0xde, 0x03, 0x01]***REMOVED******REMOVED***;
  t.ok(reader***REMOVED***;
  t.equal(reader.readInt(***REMOVED***, 0x7ede0301, 'wrong value'***REMOVED***;
  t.equal(reader.length, 0x04, 'wrong length'***REMOVED***;
  t.end(***REMOVED***;
}***REMOVED***;


test('read boolean true', function(t***REMOVED*** {
  var reader = new BerReader(new Buffer([0x01, 0x01, 0xff]***REMOVED******REMOVED***;
  t.ok(reader***REMOVED***;
  t.equal(reader.readBoolean(***REMOVED***, true, 'wrong value'***REMOVED***;
  t.equal(reader.length, 0x01, 'wrong length'***REMOVED***;
  t.end(***REMOVED***;
}***REMOVED***;


test('read boolean false', function(t***REMOVED*** {
  var reader = new BerReader(new Buffer([0x01, 0x01, 0x00]***REMOVED******REMOVED***;
  t.ok(reader***REMOVED***;
  t.equal(reader.readBoolean(***REMOVED***, false, 'wrong value'***REMOVED***;
  t.equal(reader.length, 0x01, 'wrong length'***REMOVED***;
  t.end(***REMOVED***;
}***REMOVED***;


test('read enumeration', function(t***REMOVED*** {
  var reader = new BerReader(new Buffer([0x0a, 0x01, 0x20]***REMOVED******REMOVED***;
  t.ok(reader***REMOVED***;
  t.equal(reader.readEnumeration(***REMOVED***, 0x20, 'wrong value'***REMOVED***;
  t.equal(reader.length, 0x01, 'wrong length'***REMOVED***;
  t.end(***REMOVED***;
}***REMOVED***;


test('read string', function(t***REMOVED*** {
  var dn = 'cn=foo,ou=unit,o=test';
  var buf = new Buffer(dn.length + 2***REMOVED***;
  buf[0] = 0x04;
  buf[1] = Buffer.byteLength(dn***REMOVED***;
  buf.write(dn, 2***REMOVED***;
  var reader = new BerReader(buf***REMOVED***;
  t.ok(reader***REMOVED***;
  t.equal(reader.readString(***REMOVED***, dn, 'wrong value'***REMOVED***;
  t.equal(reader.length, dn.length, 'wrong length'***REMOVED***;
  t.end(***REMOVED***;
}***REMOVED***;


test('read sequence', function(t***REMOVED*** {
  var reader = new BerReader(new Buffer([0x30, 0x03, 0x01, 0x01, 0xff]***REMOVED******REMOVED***;
  t.ok(reader***REMOVED***;
  t.equal(reader.readSequence(***REMOVED***, 0x30, 'wrong value'***REMOVED***;
  t.equal(reader.length, 0x03, 'wrong length'***REMOVED***;
  t.equal(reader.readBoolean(***REMOVED***, true, 'wrong value'***REMOVED***;
  t.equal(reader.length, 0x01, 'wrong length'***REMOVED***;
  t.end(***REMOVED***;
}***REMOVED***;


test('anonymous LDAPv3 bind', function(t***REMOVED*** {
  var BIND = new Buffer(14***REMOVED***;
  BIND[0] = 0x30;  // Sequence
  BIND[1] = 12;    // len
  BIND[2] = 0x02;  // ASN.1 Integer
  BIND[3] = 1;     // len
  BIND[4] = 0x04;  // msgid (make up 4***REMOVED***
  BIND[5] = 0x60;  // Bind Request
  BIND[6] = 7;     // len
  BIND[7] = 0x02;  // ASN.1 Integer
  BIND[8] = 1;     // len
  BIND[9] = 0x03;  // v3
  BIND[10] = 0x04; // String (bind dn***REMOVED***
  BIND[11] = 0;    // len
  BIND[12] = 0x80; // ContextSpecific (choice***REMOVED***
  BIND[13] = 0;    // simple bind

  // Start testing ^^
  var ber = new BerReader(BIND***REMOVED***;
  t.equal(ber.readSequence(***REMOVED***, 48, 'Not an ASN.1 Sequence'***REMOVED***;
  t.equal(ber.length, 12, 'Message length should be 12'***REMOVED***;
  t.equal(ber.readInt(***REMOVED***, 4, 'Message id should have been 4'***REMOVED***;
  t.equal(ber.readSequence(***REMOVED***, 96, 'Bind Request should have been 96'***REMOVED***;
  t.equal(ber.length, 7, 'Bind length should have been 7'***REMOVED***;
  t.equal(ber.readInt(***REMOVED***, 3, 'LDAP version should have been 3'***REMOVED***;
  t.equal(ber.readString(***REMOVED***, '', 'Bind DN should have been empty'***REMOVED***;
  t.equal(ber.length, 0, 'string length should have been 0'***REMOVED***;
  t.equal(ber.readByte(***REMOVED***, 0x80, 'Should have been ContextSpecific (choice***REMOVED***'***REMOVED***;
  t.equal(ber.readByte(***REMOVED***, 0, 'Should have been simple bind'***REMOVED***;
  t.equal(null, ber.readByte(***REMOVED***, 'Should be out of data'***REMOVED***;
  t.end(***REMOVED***;
}***REMOVED***;


test('long string', function(t***REMOVED*** {
  var buf = new Buffer(256***REMOVED***;
  var o;
  var s =
    '2;649;CN=Red Hat CS 71GA Demo,O=Red Hat CS 71GA Demo,C=US;' +
    'CN=RHCS Agent - admin01,UID=admin01,O=redhat,C=US [1] This is ' +
    'Teena Vradmin\'s description.';
  buf[0] = 0x04;
  buf[1] = 0x81;
  buf[2] = 0x94;
  buf.write(s, 3***REMOVED***;
  var ber = new BerReader(buf.slice(0, 3 + s.length***REMOVED******REMOVED***;
  t.equal(ber.readString(***REMOVED***, s***REMOVED***;
  t.end(***REMOVED***;
}***REMOVED***;
