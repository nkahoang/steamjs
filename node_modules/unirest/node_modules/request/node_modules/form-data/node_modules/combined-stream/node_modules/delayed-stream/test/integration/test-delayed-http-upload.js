var common = require('../common'***REMOVED***;
var assert = common.assert;
var DelayedStream = common.DelayedStream;
var ***REMOVED***;

var UPLOAD = new Buffer(10 * 1024 * 1024***REMOVED***;

var server = http.createServer(function(req, res***REMOVED*** {
  var delayed = DelayedStream.create(req, {maxDataSize: UPLOAD.length}***REMOVED***;

  setTimeout(function(***REMOVED*** {
    res.writeHead(200***REMOVED***;
    delayed.pipe(res***REMOVED***;
***REMOVED***, 10***REMOVED***;
}***REMOVED***;
server.listen(common.PORT, function(***REMOVED*** {
  var request = http.request({
    method: 'POST',
    port: common.PORT,
***REMOVED******REMOVED***;

  request.write(UPLOAD***REMOVED***;
  request.end(***REMOVED***;

  request.on('response', function(res***REMOVED*** {
    var received = 0;
    res
      .on('data', function(chunk***REMOVED*** {
        received += chunk.length;
    ***REMOVED******REMOVED***
      .on('end', function(***REMOVED*** {
        assert.equal(received, UPLOAD.length***REMOVED***;
        server.close(***REMOVED***;
    ***REMOVED******REMOVED***;
***REMOVED******REMOVED***;
}***REMOVED***;


