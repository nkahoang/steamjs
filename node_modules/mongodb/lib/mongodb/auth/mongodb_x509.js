var DbCommand = require('../commands/db_command'***REMOVED***.DbCommand
  , utils = require('../utils'***REMOVED***
  , Binary = require('bson'***REMOVED***.Binary
  , format = require('util'***REMOVED***.format;

var authenticate = function(db, username, password, options, callback***REMOVED*** {
  var numberOfConnections = 0;
  var errorObject = null;
  
  if(options['connection'] != null***REMOVED*** {
    //if a connection was explicitly passed on options, then we have only one...
    numberOfConnections = 1;
***REMOVED*** else {
    // Get the amount of connections in the pool to ensure we have authenticated all comments
    numberOfConnections = db.serverConfig.allRawConnections(***REMOVED***.length;
    options['onAll'] = true;
***REMOVED***

  // Let's start the sasl process
  var command = {
      authenticate: 1
    , mechanism: 'MONGODB-X509'
    , user: username
***REMOVED***;

  // Grab all the connections
  var connections = options['connection'] != null ? [options['connection']] : db.serverConfig.allRawConnections(***REMOVED***;

  // Authenticate all connections
  for(var i = 0; i < numberOfConnections; i++***REMOVED*** {
    var connection = connections[i];
    // Execute first sasl step
    db._executeQueryCommand(DbCommand.createDbCommand(db, command, {}, '$external'***REMOVED***, {connection:connection}, function(err, result***REMOVED*** {
      // Count down
      numberOfConnections = numberOfConnections - 1;

      // Ensure we save any error
      if(err***REMOVED*** {
        errorObject = err;
    ***REMOVED*** else if(result.documents[0].err != null || result.documents[0].errmsg != null***REMOVED***{
        errorObject = utils.toError(result.documents[0]***REMOVED***;
    ***REMOVED***

      // Work around the case where the number of connections are 0
      if(numberOfConnections <= 0 && typeof callback == 'function'***REMOVED*** {
        var internalCallback = callback;
        callback = null;

        if(errorObject == null && result.documents[0].ok == 1***REMOVED*** {
          // We authenticated correctly save the credentials
          db.serverConfig.auth.add('MONGODB-X509', db.databaseName, username, password***REMOVED***;
          // Return callback
          internalCallback(errorObject, true***REMOVED***;
      ***REMOVED*** else {
          internalCallback(errorObject, false***REMOVED***;
      ***REMOVED***
    ***REMOVED***
  ***REMOVED******REMOVED***;
***REMOVED***
}

exports.authenticate = authenticate;