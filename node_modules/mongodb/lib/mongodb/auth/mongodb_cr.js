var DbCommand = require('../commands/db_command'***REMOVED***.DbCommand
  , utils = require('../utils'***REMOVED***
  , crypto = require('crypto'***REMOVED***;

var authenticate = function(db, username, password, authdb, options, callback***REMOVED*** {
  var numberOfConnections = 0;
  var errorObject = null;

  if(options['connection'] != null***REMOVED*** {
    //if a connection was explicitly passed on options, then we have only one...
    numberOfConnections = 1;
***REMOVED*** else {
    // Get the amount of connections in the pool to ensure we have authenticated all comments
    numberOfConnections = db.serverConfig.allRawConnections(***REMOVED***.length;
    options['onAll'] = true;
***REMOVED***

  // Return connection option
  options.returnConnection = true;

  // Execute nonce command
  db.command({'getnonce':1}, options, function(err, result, connection***REMOVED*** {
    // Execute on all the connections
    if(err == null***REMOVED*** {
      // Nonce used to make authentication request with md5 hash
      var nonce = result.nonce;

      // Use node md5 generator
      var md5 = crypto.createHash('md5'***REMOVED***;
      // Generate keys used for authentication
      md5.update(username + ":mongo:" + password***REMOVED***;
      var hash_password = md5.digest('hex'***REMOVED***;
      // Final key
      md5 = crypto.createHash('md5'***REMOVED***;
      md5.update(nonce + username + hash_password***REMOVED***;
      var key = md5.digest('hex'***REMOVED***;
      
      // Creat cmd
      var cmd = {'authenticate':1, 'user':username, 'nonce':nonce, 'key':key};

      // Execute command
      db.db(authdb***REMOVED***.command(cmd, {connection:connection}, function(err, result***REMOVED*** {
        // Count down
        numberOfConnections = numberOfConnections - 1;
        // Ensure we save any error
        if(err***REMOVED*** errorObject = err;

        // Work around the case where the number of connections are 0
        if(numberOfConnections <= 0 && typeof callback == 'function'***REMOVED*** {
          var internalCallback = callback;
          callback = null;

          if(errorObject == null && result.ok***REMOVED*** {
            db.serverConfig.auth.add('MONGODB-CR', db.databaseName, username, password, authdb***REMOVED***;
            // Return callback
            internalCallback(errorObject, true***REMOVED***;
        ***REMOVED*** else {
            internalCallback(errorObject, false***REMOVED***;
        ***REMOVED***
      ***REMOVED***
    ***REMOVED******REMOVED***;
  ***REMOVED***
***REMOVED******REMOVED***;
}

exports.authenticate = authenticate;