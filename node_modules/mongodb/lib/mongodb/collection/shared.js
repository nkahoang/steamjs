// ***************************************************
// Write concerns
// ***************************************************
var _hasWriteConcern = function(errorOptions***REMOVED*** {
  return errorOptions == true
    || errorOptions.w > 0
    || errorOptions.w == 'majority'
    || errorOptions.j == true
    || errorOptions.journal == true
    || errorOptions.fsync == true
}

var _setWriteConcernHash = function(options***REMOVED*** {
  var finalOptions = {};
  if(options.w != null***REMOVED*** finalOptions.w = options.w;  
  if(options.journal == true***REMOVED*** finalOptions.j = options.journal;
  if(options.j == true***REMOVED*** finalOptions.j = options.j;
  if(options.fsync == true***REMOVED*** finalOptions.fsync = options.fsync;
  if(options.wtimeout != null***REMOVED*** finalOptions.wtimeout = options.wtimeout;  
  return finalOptions;
}

var _getWriteConcern = function(self, options***REMOVED*** {
  // Final options
  var finalOptions = {w:1};
  // Local options verification
  if(options.w != null || typeof options.j == 'boolean' || typeof options.journal == 'boolean' || typeof options.fsync == 'boolean'***REMOVED*** {
    finalOptions = _setWriteConcernHash(options***REMOVED***;
***REMOVED*** else if(typeof options.safe == "boolean"***REMOVED*** {
    finalOptions = {w: (options.safe ? 1 : 0***REMOVED***};
***REMOVED*** else if(options.safe != null && typeof options.safe == 'object'***REMOVED*** {
    finalOptions = _setWriteConcernHash(options.safe***REMOVED***;
***REMOVED*** else if(self.opts.w != null || typeof self.opts.j == 'boolean' || typeof self.opts.journal == 'boolean' || typeof self.opts.fsync == 'boolean'***REMOVED*** {
    finalOptions = _setWriteConcernHash(self.opts***REMOVED***;
***REMOVED*** else if(typeof self.opts.safe == "boolean"***REMOVED*** {
    finalOptions = {w: (self.opts.safe ? 1 : 0***REMOVED***};
***REMOVED*** else if(self.db.safe.w != null || typeof self.db.safe.j == 'boolean' || typeof self.db.safe.journal == 'boolean' || typeof self.db.safe.fsync == 'boolean'***REMOVED*** {
    finalOptions = _setWriteConcernHash(self.db.safe***REMOVED***;
***REMOVED*** else if(self.db.options.w != null || typeof self.db.options.j == 'boolean' || typeof self.db.options.journal == 'boolean' || typeof self.db.options.fsync == 'boolean'***REMOVED*** {
    finalOptions = _setWriteConcernHash(self.db.options***REMOVED***;
***REMOVED*** else if(typeof self.db.safe == "boolean"***REMOVED*** {
    finalOptions = {w: (self.db.safe ? 1 : 0***REMOVED***};
***REMOVED***

  // Ensure we don't have an invalid combination of write concerns
  if(finalOptions.w < 1 
    && (finalOptions.journal == true || finalOptions.j == true || finalOptions.fsync == true***REMOVED******REMOVED*** throw new Error("No acknowlegement using w < 1 cannot be combined with journal:true or fsync:true"***REMOVED***;

  // Return the options
  return finalOptions;
}

var _getReadConcern = function(self, options***REMOVED*** {
  if(options.readPreference***REMOVED*** return options.readPreference;
  if(self.readPreference***REMOVED*** return self.readPreference;
  if(self.db.readPreference***REMOVED*** return self.readPreference;
  return 'primary';
}

/**
 * @ignore
 */
var checkCollectionName = function checkCollectionName (collectionName***REMOVED*** {
  if('string' !== typeof collectionName***REMOVED*** {
    throw Error("collection name must be a String"***REMOVED***;
***REMOVED***

  if(!collectionName || collectionName.indexOf('..'***REMOVED*** != -1***REMOVED*** {
    throw Error("collection names cannot be empty"***REMOVED***;
***REMOVED***

  if(collectionName.indexOf('$'***REMOVED*** != -1 &&
      collectionName.match(/((^\$cmd***REMOVED***|(oplog\.\$main***REMOVED******REMOVED***/***REMOVED*** == null***REMOVED*** {
    throw Error("collection names must not contain '$'"***REMOVED***;
***REMOVED***

  if(collectionName.match(/^\.|\.$/***REMOVED*** != null***REMOVED*** {
    throw Error("collection names must not start or end with '.'"***REMOVED***;
***REMOVED***

  // Validate that we are not passing 0x00 in the colletion name
  if(!!~collectionName.indexOf("\x00"***REMOVED******REMOVED*** {
    throw new Error("collection names cannot contain a null character"***REMOVED***;
***REMOVED***
};


/**
 * Normalizes a `hint` argument.
 *
 * @param {String|Object|Array} hint
 * @return {Object}
 * @api private
 */
var normalizeHintField = function normalizeHintField(hint***REMOVED*** {
  var finalHint = null;

  if(typeof hint == 'string'***REMOVED*** {
    finalHint = hint;
***REMOVED*** else if(Array.isArray(hint***REMOVED******REMOVED*** {
    finalHint = {};

    hint.forEach(function(param***REMOVED*** {
      finalHint[param] = 1;
  ***REMOVED******REMOVED***;  
***REMOVED*** else if(hint != null && typeof hint == 'object'***REMOVED*** {
    finalHint = {};
    for (var name in hint***REMOVED*** {
      finalHint[name] = hint[name];
  ***REMOVED***    
***REMOVED***

  return finalHint;
};

exports._getWriteConcern = _getWriteConcern;
exports._hasWriteConcern = _hasWriteConcern;
exports._getReadConcern = _getReadConcern;
exports.checkCollectionName = checkCollectionName;
exports.normalizeHintField = normalizeHintField;