#include "kerberos_sspi.h"
#include <stdlib.h>
#include <stdio.h>

static HINSTANCE _sspi_security_dll = NULL; 
static HINSTANCE _sspi_secur32_dll = NULL;

/**
 * Encrypt A Message
 */
SECURITY_STATUS SEC_ENTRY _sspi_EncryptMessage(PCtxtHandle phContext, unsigned long fQOP, PSecBufferDesc pMessage, unsigned long MessageSeqNo***REMOVED*** {
  // Create function pointer instance
  encryptMessage_fn pfn_encryptMessage = NULL;

  // Return error if library not loaded
  if(_sspi_security_dll == NULL***REMOVED*** return -1;

  // Map function to library method
  pfn_encryptMessage = (encryptMessage_fn***REMOVED***GetProcAddress(_sspi_security_dll, "EncryptMessage"***REMOVED***;
  // Check if the we managed to map function pointer
  if(!pfn_encryptMessage***REMOVED*** {
    printf("GetProcAddress failed.\n"***REMOVED***;
    return -2;
***REMOVED***

  // Call the function
  return (*pfn_encryptMessage***REMOVED***(phContext, fQOP, pMessage, MessageSeqNo***REMOVED***;
}

/**
 * Acquire Credentials
 */
SECURITY_STATUS SEC_ENTRY _sspi_AcquireCredentialsHandle(
  LPSTR pszPrincipal, LPSTR pszPackage, unsigned long fCredentialUse,
  void * pvLogonId, void * pAuthData, SEC_GET_KEY_FN pGetKeyFn, void * pvGetKeyArgument,
  PCredHandle phCredential, PTimeStamp ptsExpiry
***REMOVED*** {
  SECURITY_STATUS     status;
  // Create function pointer instance
  acquireCredentialsHandle_fn pfn_acquireCredentialsHandle = NULL;

  // Return error if library not loaded
  if(_sspi_security_dll == NULL***REMOVED*** return -1;

  // Map function
  #ifdef _UNICODE
      pfn_acquireCredentialsHandle = (acquireCredentialsHandle_fn***REMOVED***GetProcAddress(_sspi_security_dll, "AcquireCredentialsHandleW"***REMOVED***;
  #else
      pfn_acquireCredentialsHandle = (acquireCredentialsHandle_fn***REMOVED***GetProcAddress(_sspi_security_dll, "AcquireCredentialsHandleA"***REMOVED***;
  #endif

  // Check if the we managed to map function pointer
  if(!pfn_acquireCredentialsHandle***REMOVED*** {
    printf("GetProcAddress failed.\n"***REMOVED***;
    return -2;
***REMOVED***

  // Status
  status = (*pfn_acquireCredentialsHandle***REMOVED***(pszPrincipal, pszPackage, fCredentialUse,
      pvLogonId, pAuthData, pGetKeyFn, pvGetKeyArgument, phCredential, ptsExpiry
    ***REMOVED***;

  // Call the function
  return status;
}

/**
 * Delete Security Context
 */
SECURITY_STATUS SEC_ENTRY _sspi_DeleteSecurityContext(PCtxtHandle phContext***REMOVED*** {
  // Create function pointer instance
  deleteSecurityContext_fn pfn_deleteSecurityContext = NULL;

  // Return error if library not loaded
  if(_sspi_security_dll == NULL***REMOVED*** return -1;
  // Map function
  pfn_deleteSecurityContext = (deleteSecurityContext_fn***REMOVED***GetProcAddress(_sspi_security_dll, "DeleteSecurityContext"***REMOVED***;

  // Check if the we managed to map function pointer
  if(!pfn_deleteSecurityContext***REMOVED*** {
    printf("GetProcAddress failed.\n"***REMOVED***;
    return -2;
***REMOVED***

  // Call the function
  return (*pfn_deleteSecurityContext***REMOVED***(phContext***REMOVED***;
}

/**
 * Decrypt Message
 */
SECURITY_STATUS SEC_ENTRY _sspi_DecryptMessage(PCtxtHandle phContext, PSecBufferDesc pMessage, unsigned long MessageSeqNo, unsigned long pfQOP***REMOVED*** {
  // Create function pointer instance
  decryptMessage_fn pfn_decryptMessage = NULL;

  // Return error if library not loaded
  if(_sspi_security_dll == NULL***REMOVED*** return -1;
  // Map function
  pfn_decryptMessage = (decryptMessage_fn***REMOVED***GetProcAddress(_sspi_security_dll, "DecryptMessage"***REMOVED***;

  // Check if the we managed to map function pointer
  if(!pfn_decryptMessage***REMOVED*** {
    printf("GetProcAddress failed.\n"***REMOVED***;
    return -2;
***REMOVED***

  // Call the function
  return (*pfn_decryptMessage***REMOVED***(phContext, pMessage, MessageSeqNo, pfQOP***REMOVED***;
}

/**
 * Initialize Security Context
 */
SECURITY_STATUS SEC_ENTRY _sspi_initializeSecurityContext(
  PCredHandle phCredential, PCtxtHandle phContext,
  LPSTR pszTargetName, unsigned long fContextReq, 
  unsigned long Reserved1, unsigned long TargetDataRep, 
  PSecBufferDesc pInput, unsigned long Reserved2,
  PCtxtHandle phNewContext, PSecBufferDesc pOutput,
  unsigned long * pfContextAttr, PTimeStamp ptsExpiry
***REMOVED*** {
  SECURITY_STATUS status;
  // Create function pointer instance
  initializeSecurityContext_fn pfn_initializeSecurityContext = NULL;

  // Return error if library not loaded
  if(_sspi_security_dll == NULL***REMOVED*** return -1;
  
  // Map function
  #ifdef _UNICODE
    pfn_initializeSecurityContext = (initializeSecurityContext_fn***REMOVED***GetProcAddress(_sspi_security_dll, "InitializeSecurityContextW"***REMOVED***;
  #else
    pfn_initializeSecurityContext = (initializeSecurityContext_fn***REMOVED***GetProcAddress(_sspi_security_dll, "InitializeSecurityContextA"***REMOVED***;
  #endif

  // Check if the we managed to map function pointer
  if(!pfn_initializeSecurityContext***REMOVED*** {
    printf("GetProcAddress failed.\n"***REMOVED***;
    return -2;
***REMOVED***

  // Execute intialize context
  status = (*pfn_initializeSecurityContext***REMOVED***(
    phCredential, phContext, pszTargetName, fContextReq, 
    Reserved1, TargetDataRep, pInput, Reserved2,
    phNewContext, pOutput, pfContextAttr, ptsExpiry
  ***REMOVED***;

  // Call the function
  return status;
}
/**
 * Query Context Attributes
 */
SECURITY_STATUS SEC_ENTRY _sspi_QueryContextAttributes(
  PCtxtHandle phContext, unsigned long ulAttribute, void * pBuffer
***REMOVED*** {
  // Create function pointer instance
  queryContextAttributes_fn pfn_queryContextAttributes = NULL;

  // Return error if library not loaded
  if(_sspi_security_dll == NULL***REMOVED*** return -1;

  #ifdef _UNICODE
    pfn_queryContextAttributes = (queryContextAttributes_fn***REMOVED***GetProcAddress(_sspi_security_dll, "QueryContextAttributesW"***REMOVED***;
  #else
    pfn_queryContextAttributes = (queryContextAttributes_fn***REMOVED***GetProcAddress(_sspi_security_dll, "QueryContextAttributesA"***REMOVED***;
  #endif

  // Check if the we managed to map function pointer
  if(!pfn_queryContextAttributes***REMOVED*** {
    printf("GetProcAddress failed.\n"***REMOVED***;
    return -2;
***REMOVED***

  // Call the function
  return (*pfn_queryContextAttributes***REMOVED***(
    phContext, ulAttribute, pBuffer
  ***REMOVED***;
}

/**
 * InitSecurityInterface
 */
PSecurityFunctionTable _ssip_InitSecurityInterface(***REMOVED*** {
  INIT_SECURITY_INTERFACE InitSecurityInterface;
  PSecurityFunctionTable pSecurityInterface = NULL;

  // Return error if library not loaded
  if(_sspi_security_dll == NULL***REMOVED*** return NULL;

  #ifdef _UNICODE
    // Get the address of the InitSecurityInterface function.
    InitSecurityInterface = (INIT_SECURITY_INTERFACE***REMOVED*** GetProcAddress (
                                          _sspi_secur32_dll, 
                                          TEXT("InitSecurityInterfaceW"***REMOVED******REMOVED***;
  #else
    // Get the address of the InitSecurityInterface function.
    InitSecurityInterface = (INIT_SECURITY_INTERFACE***REMOVED*** GetProcAddress (
                                          _sspi_secur32_dll, 
                                          TEXT("InitSecurityInterfaceA"***REMOVED******REMOVED***;
  #endif

  if(!InitSecurityInterface***REMOVED*** {
    printf (TEXT("Failed in getting the function address, Error: %x"***REMOVED***, GetLastError (***REMOVED******REMOVED***;
    return NULL;
***REMOVED***

  // Use InitSecurityInterface to get the function table.
  pSecurityInterface = (*InitSecurityInterface***REMOVED***(***REMOVED***;

  if(!pSecurityInterface***REMOVED*** {
    printf (TEXT("Failed in getting the function table, Error: %x"***REMOVED***, GetLastError (***REMOVED******REMOVED***;
    return NULL;
***REMOVED***

  return pSecurityInterface;
}

/**
 * Load security.dll dynamically
 */
int load_library(***REMOVED*** {
  DWORD err;
  // Load the library
  _sspi_security_dll = LoadLibrary("security.dll"***REMOVED***;

  // Check if the library loaded
  if(_sspi_security_dll == NULL***REMOVED*** {
    err = GetLastError(***REMOVED***;
    return err;
***REMOVED***

  // Load the library
  _sspi_secur32_dll = LoadLibrary("secur32.dll"***REMOVED***;

  // Check if the library loaded
  if(_sspi_secur32_dll == NULL***REMOVED*** {
    err = GetLastError(***REMOVED***;
    return err;
***REMOVED***

  return 0;
}