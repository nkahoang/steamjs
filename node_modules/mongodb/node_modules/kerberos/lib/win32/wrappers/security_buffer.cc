#include <node.h>
#include <assert.h>
#include <string.h>
#include <stdlib.h>
#include <v8.h>
#include <node_buffer.h>
#include <cstring>
#include <cmath>
#include <cstdlib>
#include <iostream>
#include <limits>

#include "security_buffer.h"

using namespace node;

static Handle<Value> VException(const char *msg***REMOVED*** {
  HandleScope scope;
  return ThrowException(Exception::Error(String::New(msg***REMOVED******REMOVED******REMOVED***;
};

Persistent<FunctionTemplate> SecurityBuffer::constructor_template;

SecurityBuffer::SecurityBuffer(uint32_t security_type, size_t size***REMOVED*** : ObjectWrap(***REMOVED*** {
  this->size = size;
  this->data = calloc(size, sizeof(char***REMOVED******REMOVED***;
  this->security_type = security_type;
  // Set up the data in the sec_buffer
  this->sec_buffer.BufferType = security_type;
  this->sec_buffer.cbBuffer = (unsigned long***REMOVED***size;
  this->sec_buffer.pvBuffer = this->data;  
}

SecurityBuffer::SecurityBuffer(uint32_t security_type, size_t size, void *data***REMOVED*** : ObjectWrap(***REMOVED*** {
  this->size = size;
  this->data = data;
  this->security_type = security_type;
  // Set up the data in the sec_buffer
  this->sec_buffer.BufferType = security_type;
  this->sec_buffer.cbBuffer = (unsigned long***REMOVED***size;
  this->sec_buffer.pvBuffer = this->data;  
}

SecurityBuffer::~SecurityBuffer(***REMOVED*** {
  free(this->data***REMOVED***;
}

Handle<Value> SecurityBuffer::New(const Arguments &args***REMOVED*** {
  HandleScope scope;  
  SecurityBuffer *security_obj;

  if(args.Length(***REMOVED*** != 2***REMOVED***
    return VException("Two parameters needed integer buffer type and  [32 bit integer/Buffer] required"***REMOVED***;

  if(!args[0]->IsInt32(***REMOVED******REMOVED***
    return VException("Two parameters needed integer buffer type and  [32 bit integer/Buffer] required"***REMOVED***;

  if(!args[1]->IsInt32(***REMOVED*** && !Buffer::HasInstance(args[1]***REMOVED******REMOVED***
    return VException("Two parameters needed integer buffer type and  [32 bit integer/Buffer] required"***REMOVED***;

  // Unpack buffer type
  uint32_t buffer_type = args[0]->ToUint32(***REMOVED***->Value(***REMOVED***;

  // If we have an integer
  if(args[1]->IsInt32(***REMOVED******REMOVED*** {
    security_obj = new SecurityBuffer(buffer_type, args[1]->ToUint32(***REMOVED***->Value(***REMOVED******REMOVED***;
***REMOVED*** else {
    // Get the length of the Buffer
    size_t length = Buffer::Length(args[1]->ToObject(***REMOVED******REMOVED***;
    // Allocate space for the internal void data pointer
    void *data = calloc(length, sizeof(char***REMOVED******REMOVED***;
    // Write the data to out of V8 heap space
    memcpy(data, Buffer::Data(args[1]->ToObject(***REMOVED******REMOVED***, length***REMOVED***;
    // Create new SecurityBuffer
    security_obj = new SecurityBuffer(buffer_type, length, data***REMOVED***;
***REMOVED***
  
  // Wrap it
  security_obj->Wrap(args.This(***REMOVED******REMOVED***;
  // Return the object
  return args.This(***REMOVED***;    
}

Handle<Value> SecurityBuffer::ToBuffer(const Arguments &args***REMOVED*** {
  HandleScope scope; 

  // Unpack the Security Buffer object
  SecurityBuffer *security_obj = ObjectWrap::Unwrap<SecurityBuffer>(args.This(***REMOVED******REMOVED***;
  // Create a Buffer
  Buffer *buffer = Buffer::New((char ****REMOVED***security_obj->data, (size_t***REMOVED***security_obj->size***REMOVED***;

  // Return the buffer
  return scope.Close(buffer->handle_***REMOVED***;  
}

void SecurityBuffer::Initialize(Handle<Object> target***REMOVED*** {
  // Grab the scope of the call from Node
  HandleScope scope;
  // Define a new function template
  Local<FunctionTemplate> t = FunctionTemplate::New(New***REMOVED***;
  constructor_template = Persistent<FunctionTemplate>::New(t***REMOVED***;
  constructor_template->InstanceTemplate(***REMOVED***->SetInternalFieldCount(1***REMOVED***;
  constructor_template->SetClassName(String::NewSymbol("SecurityBuffer"***REMOVED******REMOVED***;

  // Set up method for the Kerberos instance
  NODE_SET_PROTOTYPE_METHOD(constructor_template, "toBuffer", ToBuffer***REMOVED***;
 
  // Set up class
  target->Set(String::NewSymbol("SecurityBuffer"***REMOVED***, constructor_template->GetFunction(***REMOVED******REMOVED***;  
}
