// A simple web server that generates dyanmic content based on responses from Redis

var http = require("http"***REMOVED***, server,
    redis_client = require("redis"***REMOVED***.createClient(***REMOVED***;

server = http.createServer(function (request, response***REMOVED*** {
    response.writeHead(200, {
        "Content-Type": "text/plain"
  ***REMOVED******REMOVED***;
    
    var redis_info, total_requests;
    
    redis_client.info(function (err, reply***REMOVED*** {
        redis_info = reply; // stash response in outer scope
  ***REMOVED******REMOVED***;
    redis_client.incr("requests", function (err, reply***REMOVED*** {
        total_requests = reply; // stash response in outer scope
  ***REMOVED******REMOVED***;
    redis_client.hincrby("ip", request.connection.remoteAddress, 1***REMOVED***;
    redis_client.hgetall("ip", function (err, reply***REMOVED*** {
        // This is the last reply, so all of the previous replies must have completed already
        response.write("This page was generated after talking to redis.\n\n" +
            "Redis info:\n" + redis_info + "\n" +
            "Total requests: " + total_requests + "\n\n" +
            "IP count: \n"***REMOVED***;
        Object.keys(reply***REMOVED***.forEach(function (ip***REMOVED*** {
            response.write("    " + ip + ": " + reply[ip] + "\n"***REMOVED***;
      ***REMOVED******REMOVED***;
        response.end(***REMOVED***;
  ***REMOVED******REMOVED***;
}***REMOVED***.listen(80***REMOVED***;
