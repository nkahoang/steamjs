'use strict';

var freemem = require('os'***REMOVED***.freemem;
var profiler = require('v8-profiler'***REMOVED***;
var codec = require('../codec'***REMOVED***;

var sent = 0;

var pub = require('redis'***REMOVED***.createClient(null, null, {
	//command_queue_high_water: 5,
	//command_queue_low_water: 1
}***REMOVED***
.on('ready', function(***REMOVED*** {
	this.emit('drain'***REMOVED***;
}***REMOVED***
.on('drain', function(***REMOVED*** {
	process.nextTick(exec***REMOVED***;
}***REMOVED***;

var payload = '1'; for (var i = 0; i < 12; ++i***REMOVED*** payload += payload;
console.log('Message payload length', payload.length***REMOVED***;

function exec(***REMOVED*** {
	pub.publish('timeline', codec.encode({ foo: payload }***REMOVED******REMOVED***;
	++sent;
	if (!pub.should_buffer***REMOVED*** {
		process.nextTick(exec***REMOVED***;
	}
}

profiler.takeSnapshot('s_0'***REMOVED***;

exec(***REMOVED***;

setInterval(function(***REMOVED*** {
	profiler.takeSnapshot('s_' + sent***REMOVED***;
	console.error('sent', sent, 'free', freemem(***REMOVED***, 'cmdqlen', pub.command_queue.length, 'offqlen', pub.offline_queue.length***REMOVED***;
}, 2000***REMOVED***;
