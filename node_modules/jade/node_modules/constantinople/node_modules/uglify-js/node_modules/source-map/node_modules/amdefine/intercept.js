/*jshint node: true */
var inserted,
    Module = require('module'***REMOVED***,
    fs = require('fs'***REMOVED***,
    existingExtFn = Module._extensions['.js'],
    amdefineRegExp = /amdefine\.js/;

inserted  = "if (typeof define !== 'function'***REMOVED*** {var define = require('amdefine'***REMOVED***(module***REMOVED***}";

//From the node/lib/module.js source:
function stripBOM(content***REMOVED*** {
    // Remove byte order marker. This catches EF BB BF (the UTF-8 BOM***REMOVED***
    // because the buffer-to-string conversion in `fs.readFileSync(***REMOVED***`
    // translates it to FEFF, the UTF-16 BOM.
    if (content.charCodeAt(0***REMOVED*** === 0xFEFF***REMOVED*** {
        content = content.slice(1***REMOVED***;
  ***REMOVED***
    return content;
}

//Also adapted from the node/lib/module.js source:
function intercept(module, filename***REMOVED*** {
    var content = stripBOM(fs.readFileSync(filename, 'utf8'***REMOVED******REMOVED***;

    if (!amdefineRegExp.test(module.id***REMOVED******REMOVED*** {
        content = inserted + content;
  ***REMOVED***

    module._compile(content, filename***REMOVED***;
}

intercept._id = 'amdefine/intercept';

if (!existingExtFn._id || existingExtFn._id !== intercept._id***REMOVED*** {
    Module._extensions['.js'] = intercept;
}
