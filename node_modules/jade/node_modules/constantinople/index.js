'use strict'

var uglify = require('uglify-js'***REMOVED***

var lastSRC = '(null***REMOVED***'
var lastRes = true
var lastConstants = undefined;

module.exports = isConstant
function isConstant(src, constants***REMOVED*** {
  src = '(' + src + '***REMOVED***'
  if (lastSRC === src && lastConstants === constants***REMOVED*** return lastRes
  lastSRC = src
  try {
    return lastRes = (detect(src***REMOVED***.filter(function (key***REMOVED*** {
      return !constants || !(key in constants***REMOVED***
  ***REMOVED******REMOVED***.length === 0***REMOVED***
***REMOVED*** catch (ex***REMOVED*** {
    return lastRes = false
***REMOVED***
}
isConstant.isConstant = isConstant

isConstant.toConstant = toConstant
function toConstant(src, constants***REMOVED*** {
  if (!isConstant(src, constants***REMOVED******REMOVED*** throw new Error(JSON.stringify(src***REMOVED*** + ' is not constant.'***REMOVED***
  return Function(Object.keys(constants || {}***REMOVED***.join(','***REMOVED***, 'return (' + src + '***REMOVED***'***REMOVED***.apply(null, Object.keys(constants || {}***REMOVED***.map(function (key***REMOVED*** {
    return constants[key];
***REMOVED******REMOVED******REMOVED***;
}

function detect(src***REMOVED*** {
  var ast = uglify.parse(src.toString(***REMOVED******REMOVED***
  ast.figure_out_scope(***REMOVED***
  var globals = ast.globals
    .map(function (node, name***REMOVED*** {
      return name
  ***REMOVED******REMOVED***
  return globals
}