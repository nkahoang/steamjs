var mkdirp = require('../'***REMOVED***.mkdirp;
var ***REMOVED***;
var fs = require('fs'***REMOVED***;
var test = require('tap'***REMOVED***.test;

test('race', function (t***REMOVED*** {
    t.plan(4***REMOVED***;
    var ps = [ '', 'tmp' ];
    
    for (var i = 0; i < 25; i++***REMOVED*** {
        var dir = Math.floor(Math.random(***REMOVED*** * Math.pow(16,4***REMOVED******REMOVED***.toString(16***REMOVED***;
        ps.push(dir***REMOVED***;
  ***REMOVED***
    var file = ps.join('/'***REMOVED***;
    
    var res = 2;
    mk(file, function (***REMOVED*** {
        if (--res === 0***REMOVED*** t.end(***REMOVED***;
  ***REMOVED******REMOVED***;
    
    mk(file, function (***REMOVED*** {
        if (--res === 0***REMOVED*** t.end(***REMOVED***;
  ***REMOVED******REMOVED***;
    
    function mk (file, cb***REMOVED*** {
        mkdirp(file, 0755, function (err***REMOVED*** {
            if (err***REMOVED*** t.fail(err***REMOVED***;
            else path.exists(file, function (ex***REMOVED*** {
                if (!ex***REMOVED*** t.fail('file not created'***REMOVED***
                else fs.stat(file, function (err, stat***REMOVED*** {
                    if (err***REMOVED*** t.fail(err***REMOVED***
                    else {
                        t.equal(stat.mode & 0777, 0755***REMOVED***;
                        t.ok(stat.isDirectory(***REMOVED***, 'target not a directory'***REMOVED***;
                        if (cb***REMOVED*** cb(***REMOVED***;
                  ***REMOVED***
              ***REMOVED******REMOVED***
          ***REMOVED******REMOVED***
      ***REMOVED******REMOVED***;
  ***REMOVED***
}***REMOVED***;
