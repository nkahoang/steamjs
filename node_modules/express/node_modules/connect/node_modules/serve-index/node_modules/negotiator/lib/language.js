module.exports = preferredLanguages;
preferredLanguages.preferredLanguages = preferredLanguages;

function parseAcceptLanguage(accept***REMOVED*** {
  return accept.split(','***REMOVED***.map(function(e***REMOVED*** {
    return parseLanguage(e.trim(***REMOVED******REMOVED***;
***REMOVED******REMOVED***.filter(function(e***REMOVED*** {
    return e;
***REMOVED******REMOVED***;
}

function parseLanguage(s***REMOVED*** {
  var match = s.match(/^\s*(\S+?***REMOVED***(?:-(\S+?***REMOVED******REMOVED***?\s*(?:;(.****REMOVED******REMOVED***?$/***REMOVED***;
  if (!match***REMOVED*** return null;

  var prefix = match[1],
      suffix = match[2],
      full = prefix;

  if (suffix***REMOVED*** full += "-" + suffix;

  var q = 1;
  if (match[3]***REMOVED*** {
    var params = match[3].split(';'***REMOVED***
    for (var i = 0; i < params.length; i ++***REMOVED*** {
      var p = params[i].split('='***REMOVED***;
      if (p[0] === 'q'***REMOVED*** q = parseFloat(p[1]***REMOVED***;
  ***REMOVED***
***REMOVED***

  return {
    prefix: prefix,
    suffix: suffix,
    q: q,
    full: full
***REMOVED***;
}

function getLanguagePriority(language, accepted***REMOVED*** {
  return (accepted.map(function(a***REMOVED***{
    return specify(language, a***REMOVED***;
***REMOVED******REMOVED***.filter(function(a***REMOVED***{
    return a;
***REMOVED******REMOVED***.sort(function(a, b***REMOVED***{
    // revsort
    return a.s > b.s ? -1 : 1;
***REMOVED******REMOVED***[0] || {q:0}***REMOVED***.q;
}

function specify(language, spec***REMOVED*** {
  var p = parseLanguage(language***REMOVED***
  var s = 0;
  if(spec.full === p.full***REMOVED***{
    s |= 4;
***REMOVED*** else if (spec.prefix === p.full***REMOVED*** {
    s |= 2;
***REMOVED*** else if (spec.full === p.prefix***REMOVED*** {
    s |= 1;
***REMOVED*** else if (spec.full !== '*' ***REMOVED*** {
    return null
***REMOVED***

  return {
    s: s,
    q: spec.q,
***REMOVED***
};

function preferredLanguages(accept, provided***REMOVED*** {
  accept = parseAcceptLanguage(accept || ''***REMOVED***;
  if (provided***REMOVED*** {

    var ret = provided.map(function(type***REMOVED*** {
      return [type, getLanguagePriority(type, accept***REMOVED***];
  ***REMOVED******REMOVED***.filter(function(pair***REMOVED*** {
      return pair[1] > 0;
  ***REMOVED******REMOVED***.sort(function(a, b***REMOVED*** {
      // revsort
      return a[1] === b[1] ? 0 : a[1] > b[1] ? -1 : 1;
  ***REMOVED******REMOVED***.map(function(pair***REMOVED*** {
      return pair[0];
  ***REMOVED******REMOVED***;
    return ret;

***REMOVED*** else {
    return accept.sort(function (a, b***REMOVED*** {
      // revsort
      return a.q < b.q ? 1 : -1;
  ***REMOVED******REMOVED***.filter(function(type***REMOVED*** {
      return type.q > 0;
  ***REMOVED******REMOVED***.map(function(type***REMOVED*** {
      return type.full;
  ***REMOVED******REMOVED***;
***REMOVED***
}
