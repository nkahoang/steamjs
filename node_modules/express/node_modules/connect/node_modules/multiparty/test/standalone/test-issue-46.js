var http       = require('http'***REMOVED***,
    multiparty = require('../../'***REMOVED***,
    request    = require('request'***REMOVED***,
    assert     = require('assert'***REMOVED***;

var host = 'localhost';

var index = [
  '<form action="/" method="post" enctype="multipart/form-data">',
  '  <input type="text" name="foo" />',
  '  <input type="submit" />',
  '</form>'
].join("\n"***REMOVED***;

var server = http.createServer(function(req, res***REMOVED*** {

  // Show a form for testing purposes.
  if (req.method === 'GET'***REMOVED*** {
    res.writeHead(200, {'content-type': 'text/html'}***REMOVED***;
    res.end(index***REMOVED***;
    return;
***REMOVED***

  // Parse form and write results to response.
  var form = new multiparty.Form(***REMOVED***;
  form.parse(req, function(err, fields, files***REMOVED*** {
    res.writeHead(200, {'content-type': 'text/plain'}***REMOVED***;
    res.write(JSON.stringify({err: err, fields: fields, files: files}***REMOVED******REMOVED***;
    res.end(***REMOVED***;
***REMOVED******REMOVED***;

}***REMOVED***.listen(0, host, function(***REMOVED*** {

  //console.log("Server up and running..."***REMOVED***;

  var server = this,
      url    = 'http://' + host + ':' + server.address(***REMOVED***.port;

  var parts  = [
    {'Content-Disposition': 'form-data; name="foo"', 'body': 'bar'}
  ]

  var req = request({method: 'POST', url: url, multipart: parts}, function(e, res, body***REMOVED*** {
    var obj = JSON.parse(body***REMOVED***;
    assert.equal("bar", obj.fields.foo***REMOVED***;
    server.close(***REMOVED***;
***REMOVED******REMOVED***;

}***REMOVED***;
