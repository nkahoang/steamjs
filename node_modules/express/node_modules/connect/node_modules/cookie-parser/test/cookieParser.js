var connect = require('connect'***REMOVED***
  , request = require('supertest'***REMOVED***
  , signature = require('cookie-signature'***REMOVED***;

var app = connect(***REMOVED***;

app.use(connect.cookieParser('keyboard cat'***REMOVED******REMOVED***;

app.use(function(req, res, next***REMOVED***{
  if ('/signed' != req.url***REMOVED*** return next(***REMOVED***;
  res.end(JSON.stringify(req.signedCookies***REMOVED******REMOVED***;
}***REMOVED***;

app.use(function(req, res, next***REMOVED***{
  res.end(JSON.stringify(req.cookies***REMOVED******REMOVED***;
}***REMOVED***;

describe('connect.cookieParser(***REMOVED***', function(***REMOVED***{
  describe('when no cookies are sent', function(***REMOVED***{
    it('should default req.cookies to {}', function(done***REMOVED***{
      request(app***REMOVED***
      .get('/'***REMOVED***
      .expect('{}', done***REMOVED***;
  ***REMOVED******REMOVED***

    it('should default req.signedCookies to {}', function(done***REMOVED***{
      request(app***REMOVED***
      .get('/signed'***REMOVED***
      .expect('{}', done***REMOVED***;
  ***REMOVED******REMOVED***
***REMOVED******REMOVED***

  describe('when cookies are sent', function(***REMOVED***{
    it('should populate req.cookies', function(done***REMOVED***{
      request(app***REMOVED***
      .get('/'***REMOVED***
      .set('Cookie', 'foo=bar; bar=baz'***REMOVED***
      .expect('{"foo":"bar","bar":"baz"}', done***REMOVED***;
  ***REMOVED******REMOVED***
***REMOVED******REMOVED***

  describe('when a secret is given', function(***REMOVED***{
    var val = signature.sign('foobarbaz', 'keyboard cat'***REMOVED***;
    // TODO: "bar" fails...

    it('should populate req.signedCookies', function(done***REMOVED***{
      request(app***REMOVED***
      .get('/signed'***REMOVED***
      .set('Cookie', 'foo=s:' + val***REMOVED***
      .expect('{"foo":"foobarbaz"}', done***REMOVED***;
  ***REMOVED******REMOVED***

    it('should remove the signed value from req.cookies', function(done***REMOVED***{
      request(app***REMOVED***
      .get('/'***REMOVED***
      .set('Cookie', 'foo=s:' + val***REMOVED***
      .expect('{}', done***REMOVED***;
  ***REMOVED******REMOVED***

    it('should omit invalid signatures', function(done***REMOVED***{
      request(app***REMOVED***
      .get('/signed'***REMOVED***
      .set('Cookie', 'foo=' + val + '3'***REMOVED***
      .expect('{}', function(***REMOVED***{
        request(app***REMOVED***
        .get('/'***REMOVED***
        .set('Cookie', 'foo=' + val + '3'***REMOVED***
        .expect('{"foo":"foobarbaz.CP7AWaXDfAKIRfH49dQzKJx7sKzzSoPq7/AcBBRVwlI3"}', done***REMOVED***;
    ***REMOVED******REMOVED***;
  ***REMOVED******REMOVED***
***REMOVED******REMOVED***
}***REMOVED***
