// basic test
// show that it does the same thing by default as the shell.
var tap = require("tap"***REMOVED***
, child_process = require("child_process"***REMOVED***
, bashResults = require("./bash-results.json"***REMOVED***
, globs = Object.keys(bashResults***REMOVED***
, glob = require("../"***REMOVED***
, path = require("path"***REMOVED***

// run from the root of the project
// this is usually where you're at anyway, but be sure.
process.chdir(path.resolve(__dirname, ".."***REMOVED******REMOVED***

function alphasort (a, b***REMOVED*** {
  a = a.toLowerCase(***REMOVED***
  b = b.toLowerCase(***REMOVED***
  return a > b ? 1 : a < b ? -1 : 0
}

globs.forEach(function (pattern***REMOVED*** {
  var expect = bashResults[pattern]
  // anything regarding the symlink thing will fail on windows, so just skip it
  if (process.platform === "win32" &&
      expect.some(function (m***REMOVED*** {
        return /\/symlink\//.test(m***REMOVED***
    ***REMOVED******REMOVED******REMOVED***
    return

  tap.test(pattern, function (t***REMOVED*** {
    glob(pattern, function (er, matches***REMOVED*** {
      if (er***REMOVED***
        throw er

      // sort and unmark, just to match the shell results
      matches = cleanResults(matches***REMOVED***

      t.deepEqual(matches, expect, pattern***REMOVED***
      t.end(***REMOVED***
  ***REMOVED******REMOVED***
***REMOVED******REMOVED***

  tap.test(pattern + " sync", function (t***REMOVED*** {
    var matches = cleanResults(glob.sync(pattern***REMOVED******REMOVED***

    t.deepEqual(matches, expect, "should match shell"***REMOVED***
    t.end(***REMOVED***
***REMOVED******REMOVED***
}***REMOVED***

function cleanResults (m***REMOVED*** {
  // normalize discrepancies in ordering, duplication,
  // and ending slashes.
  return m.map(function (m***REMOVED*** {
    return m.replace(/\/+/g, "/"***REMOVED***.replace(/\/$/, ""***REMOVED***
***REMOVED******REMOVED***.sort(alphasort***REMOVED***.reduce(function (set, f***REMOVED*** {
    if (f !== set[set.length - 1]***REMOVED*** set.push(f***REMOVED***
    return set
***REMOVED***, []***REMOVED***.sort(alphasort***REMOVED***.map(function (f***REMOVED*** {
    // de-windows
    return (process.platform !== 'win32'***REMOVED*** ? f
           : f.replace(/^[a-zA-Z]:[\/\\]+/, '/'***REMOVED***.replace(/[\\\/]+/g, '/'***REMOVED***
***REMOVED******REMOVED***
}
